<link rel="stylesheet" href="/styles/ventas.css">

<div class="container mt-4">
    <div class="card">
        <div class="card p-4" style="background-color: #ffffff8f; border-light;">
            <h3 class="text-center" style="color: #000000;">Ventas</h3>
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" id="codigoVenta" class="form-control" placeholder="C√≥digo de Venta" disabled>
                </div>
                <div class="col-md-4">
                    <select id="sector" name="sector" class="form-select" required>
                        <option value="" disabled selected>Seleccione un sector</option>
                        {{#each sectores}}
                        <option value="{{this}}">{{this}}</option>
                        {{/each}}
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" id="empleado" class="form-control" placeholder="Empleado:" disabled />
                </div>
                <div class="col-md-4">
                    <select id="nombreProducto" class="form-select">
                        <option value="" disabled selected>Seleccione un producto</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" id="cantidad" class="form-control" placeholder="Cantidad">
                </div>
                <div class="col-md-2">
                    <input type="text" id="precio" class="form-control" placeholder="Precio">
                </div>
                <div class="col-md-4">
                    <select id="metodoPago" class="form-select">
                        <option value="" disabled selected>Seleccione M√©todo de Pago</option>
                        <option>Efectivo</option>
                        <option>Tarjeta</option>
                        <option>Transferencia</option>
                    </select>
                </div>
            </div>

            <div class="text-center mt-3">
                <button id="agregarProducto" class="btn btn-custom btn-custom-primary">‚ûï Agregar M√°s</button>
            </div>

            <div class="mt-4">
                <h5 class="text-center"
                    style="background-color: #80c7e0; color: #fff; padding: 8px; border-radius: 5px;">Lista de Productos
                </h5>
                <table class="table table-light table-striped text-center">
                    <thead class="table-secondary">
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                            <th>M√©todo de Pago</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaProductos">
                        <!-- Aqu√≠ se agregar√°n din√°micamente los productos -->
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between mt-3">
                <button id="guardarVenta" class="btn btn-custom btn-custom-success">üíæ Guardar Venta</button>
            </div>
        </div>
    </div>
</div>

<script>

    // Obtener el √∫ltimo c√≥digo de venta almacenado o inicializar en 1
    let codigoVenta = localStorage.getItem("codigoVenta") ? parseInt(localStorage.getItem("codigoVenta")) : 1;

    // Mostrar el c√≥digo de venta actual en la caja de texto
    document.getElementById("codigoVenta").value = codigoVenta;

    document.getElementById("guardarVenta").addEventListener("click", async function () {
        if (productos.length === 0) {
            alert("No se han agregado productos.");
            return;
        }

        // Datos de la venta
        const ventaData = {
            codigo_venta: codigoVenta,  // Agregar el c√≥digo de venta a los datos
            productos: productos,
            codigo_empleado: "EMP123"
        };

        // Enviar la venta al backend
        const response = await fetch("/api/ventas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(ventaData)
        });

        const data = await response.json();

        if (data.success) {
            alert("Venta registrada correctamente.");
            // Incrementar el c√≥digo de venta y almacenarlo en localStorage
            codigoVenta++;
            localStorage.setItem("codigoVenta", codigoVenta);
            document.getElementById("codigoVenta").value = codigoVenta;

            // Limpiar la lista de productos y la tabla
            productos = [];
            document.getElementById("tablaProductos").innerHTML = "";
        } else {
            alert("Error al registrar la venta: " + data.message);
        }
    });


    // Lista de productos agregados
    let productos = [];

    // Agregar un producto a la lista de productos
    document.getElementById("agregarProducto").addEventListener("click", function () {
        let nombre = document.getElementById("nombreProducto").value;
        let cantidad = document.getElementById("cantidad").value;
        let precio = document.getElementById("precio").value;
        let metodoPago = document.getElementById("metodoPago").value;
        let sector = document.getElementById("sector").value;

        if (nombre === "" || cantidad === "" || precio === "" || metodoPago === "") {
            alert("Por favor, complete todos los campos antes de agregar.");
            return;
        }

        // Agregar producto a la lista
        productos.push({
            codigo_producto: nombre,
            cantidad: cantidad,
            precio: precio,
            metodo_pago: metodoPago,
            sector: sector
        });

        // Agregar fila a la tabla
        let tabla = document.getElementById("tablaProductos");
        let fila = document.createElement("tr");

        fila.innerHTML = `
            <td>${nombre}</td>
            <td>${cantidad}</td>
            <td>${precio}</td>
            <td>${metodoPago}</td>
            <td><button class="btn btn-danger btn-sm eliminar">‚ùå Eliminar</button></td>
        `;

        tabla.appendChild(fila);

        // Limpiar los campos
        document.getElementById("nombreProducto").value = "";
        document.getElementById("cantidad").value = "";
        document.getElementById("precio").value = "";
        document.getElementById("metodoPago").value = "";

        // Eliminar producto de la tabla
        fila.querySelector(".eliminar").addEventListener("click", function () {
            productos = productos.filter(p => p.codigo_producto !== nombre);
            fila.remove();
        });
    });

    // Guardar venta
    document.getElementById("guardarVenta").addEventListener("click", async function () {
        if (productos.length === 0) {
            alert("No se han agregado productos.");
            return;
        }

        // Datos de la venta
        const ventaData = {
            productos: productos,
            codigo_empleado: "EMP123" // Aqu√≠ puedes poner el c√≥digo del empleado logueado
        };

        // Enviar la venta al backend
        const response = await fetch("/api/ventas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(ventaData)
        });

        const data = await response.json();

        if (data.success) {
            alert("Venta registrada correctamente.");
            // Limpiar la lista de productos y el formulario
            productos = [];
            document.getElementById("tablaProductos").innerHTML = "";
        } else {
            alert("Error al registrar la venta: " + data.message);
        }
    });



    // Obtener los datos del empleado logueado
    fetch('/api/empleados')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const empleado = data.empleado; // Obtiene los datos del empleado
                // Asigna el nombre y apellido del empleado al input de texto
                const empleadoInput = document.getElementById('empleado');
                empleadoInput.value = `${empleado.Nombre} ${empleado.Apellido}`;
            } else {
                console.log(data.message);  // Si no est√° autenticado, muestra el mensaje
            }
        })
        .catch(error => console.error('Error al obtener datos del empleado:', error));

    async function cargarSectores() {
        try {
            const response = await fetch("http://localhost:4000/productos/api/productos");
            const data = await response.json();

            if (data.success) {
                const sectoresUnicos = [...new Set(data.data.map(producto => producto.Sector))]; // Obtener sectores √∫nicos
                const selectSector = document.getElementById("sector");

                selectSector.innerHTML = `<option value="" disabled selected>Seleccione un sector</option>`; // Limpiar select

                sectoresUnicos.forEach(sector => {
                    const option = document.createElement("option");
                    option.value = sector;
                    option.textContent = sector;
                    selectSector.appendChild(option);
                });

                console.log("Sectores cargados:", sectoresUnicos);
            }
        } catch (error) {
            console.error("Error al cargar sectores:", error);
        }
    }

    // Llamar a la funci√≥n cuando cargue la p√°gina
    document.addEventListener("DOMContentLoaded", cargarSectores);



    async function cargarProductosPorSector(sectorSeleccionado) {
        try {
            const response = await fetch("http://localhost:4000/productos/api/productos");
            const data = await response.json();

            if (data.success) {
                const productosFiltrados = data.data.filter(producto => producto.Sector === sectorSeleccionado);
                const selectProducto = document.getElementById("nombreProducto");

                selectProducto.innerHTML = `<option value="" disabled selected>Seleccione un producto</option>`;

                productosFiltrados.forEach(producto => {
                    const option = document.createElement("option");
                    option.value = producto.Cod_Producto;
                    option.textContent = producto.Nombre;
                    selectProducto.appendChild(option);
                });

                console.log(`Productos en el sector "${sectorSeleccionado}":`, productosFiltrados);
            }
        } catch (error) {
            console.error("Error al cargar productos por sector:", error);
        }
    }

    // Detectar cambio en el select de sectores
    document.getElementById("sector").addEventListener("change", function () {
        const sectorSeleccionado = this.value;
        cargarProductosPorSector(sectorSeleccionado);
    });


</script>