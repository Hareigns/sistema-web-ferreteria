<link rel="stylesheet" href="/styles/ventas.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container mt-5 py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card p-4" style="background-color: #ffffff8f; border-light;">
                    <h3 class="text-center" style="color: #000000;">Ventas</h3>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="codigoVenta" class="form-label">Código de Venta:</label>
                            <input type="text" id="codigoVenta" class="form-control" placeholder="Código de Venta"
                                disabled>
                        </div>
                        <div class="col-md-4">
                            <label for="sector" class="form-label">Sector:</label>
                            <select id="sector" name="sector" class="form-select" required>
                                <option value="" disabled selected>Seleccione un sector</option>
                                {{#each sectores}}
                                <option value="{{this}}">{{this}}</option>
                                {{/each}}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="empleado" class="form-label">Empleado:</label>
                            <input type="text" id="empleado" class="form-control" placeholder="Empleado:" disabled />
                        </div>
                        <div class="col-md-4">
                            <label for="nombreProducto" class="form-label">Producto:</label>
                            <select id="nombreProducto" class="form-select">
                                <option value="" disabled selected>Seleccione un producto</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="cantidad" class="form-label">Cantidad:</label>
                            <input type="number" id="cantidad" class="form-control" placeholder="Cantidad" min="1"
                                required>
                        </div>
                        <div class="col-md-2">
                            <label for="precio" class="form-label">Precio:</label>
                            <input type="text" id="precio" class="form-control" placeholder="Precio" disabled>
                        </div>
                        <div class="col-md-4">
                            <label for="metodoPago" class="form-label">Método de Pago:</label>
                            <select id="metodoPago" class="form-select">
                                <option value="" disabled selected>Seleccione Método de Pago</option>
                                <option>Efectivo</option>
                                <option>Tarjeta</option>
                                <option>Transferencia</option>
                            </select>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <button id="agregarProducto" class="btn btn-custom btn-custom-primary">➕ Agregar Más</button>
                    </div>

                    <div class="mt-4">
                        <h5 class="text-center"
                            style="background-color: #80c7e0; color: #fff; padding: 8px; border-radius: 5px;">Lista de
                            Productos
                        </h5>
                        <table class="table table-light table-striped text-center">
                            <thead class="table-secondary">
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Método de Pago</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaProductos">
                                <!-- Aquí se agregarán dinámicamente los productos -->
                            </tbody>
                        </table>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <label for="subtotal" class="form-label">Subtotal:</label>
                            <input type="text" id="subtotal" class="form-control" placeholder="Subtotal" disabled>
                        </div>
                        <div class="col-md-4">
                            <label for="iva" class="form-label">IVA (15%):</label>
                            <input type="text" id="iva" class="form-control" placeholder="IVA" disabled>
                        </div>
                        <div class="col-md-4">
                            <label for="total" class="form-label">Total:</label>
                            <input type="text" id="total" class="form-control" placeholder="Total" disabled>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-3">
                        <button id="guardarVenta" class="btn btn-custom btn-custom-success">💾 Guardar Venta</button>
                    </div>

                    <div class="mt-5">
                        <h5 class="text-center"
                            style="background-color: #007bff; color: #fff; padding: 8px; border-radius: 5px;">
                            Historial de Ventas
                        </h5>
                        <div class="card p-3 table-responsive" style="border: 1px solid #ddd;">
                            <table class="table align-middle mb-0 bg-white table-striped text-center">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Código de Venta</th>
                                        <th>Código de Producto</th>
                                        <th>Cantidad</th>
                                        <th>Precio</th>
                                        <th>Método de Pago</th>
                                        <th>Sector</th>
                                        <th>Fecha</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaHistorialVentas">
                                    <!-- Se llenará dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let productos = [];

    // Modificar el evento agregarProducto para usar el nombre:
    document.getElementById("agregarProducto").addEventListener("click", async function () {
        let selectProducto = document.getElementById("nombreProducto");
        let selectedOption = selectProducto.options[selectProducto.selectedIndex];

        let codigo = selectProducto.value;
        let nombre = selectedOption.dataset.nombre;
        let cantidad = document.getElementById("cantidad").value;
        let precio = document.getElementById("precio").value;
        let metodoPago = document.getElementById("metodoPago").value;
        let sector = document.getElementById("sector").value;
        let fechaVencimiento = selectedOption.dataset.vencimiento;
        let stockDisponible = selectedOption.dataset.stock;

        // Validar campos vacíos
        if (!codigo || !cantidad || !precio || !metodoPago || !sector) {
            Swal.fire({
                icon: 'warning',
                title: 'Campos incompletos',
                text: 'Por favor, complete todos los campos antes de agregar.'
            });
            return;
        }

        // Convertir a números para validación
        const cantidadNum = parseInt(cantidad, 10);
        const stockNum = stockDisponible ? parseInt(stockDisponible, 10) : 0;

        // Calcular stock ya reservado en productos agregados
        const cantidadReservada = productos.reduce((total, p) => {
            return p.codigo_producto === codigo ? total + parseInt(p.cantidad, 10) : total;
        }, 0);

        // Stock realmente disponible (total - reservado)
        const stockRealDisponible = stockNum - cantidadReservada;

        // Validar stock disponible considerando lo ya reservado
        if (stockRealDisponible < cantidadNum) {
            Swal.fire({
                icon: 'warning',
                title: 'Stock Insuficiente',
                html: `
                <div style="text-align: left;">
                    <p style="color: #856404; background-color: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffeeba;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px; color: #ffc107;"></i>
                        No hay suficiente stock para "${nombre}"
                    </p>
                    <p style="margin-top: 15px;"><strong>Disponible total:</strong> ${stockNum}</p>
                    <p><strong>Ya reservado:</strong> ${cantidadReservada}</p>
                    <p><strong>Disponible real:</strong> ${stockRealDisponible}</p>
                    <p><strong>Solicitado:</strong> ${cantidadNum}</p>
                </div>
            `,
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#3085d6'
            });
            return;
        }

        // Validar fecha de vencimiento
        if (fechaVencimiento) {
            const hoy = new Date();
            const vencimiento = new Date(fechaVencimiento);

            if (vencimiento < hoy) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Producto Vencido',
                    html: `
                <div style="text-align: left;">
                    <p style="color: #856404; background-color: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffeeba;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px; color: #ffc107;"></i>
                        No se puede vender "${nombre}" porque está vencido
                    </p>
                    <p style="margin-top: 15px;"><strong>Vencimiento:</strong> ${vencimiento.toLocaleDateString()}</p>
                </div>
            `,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }
        }

        // Verificar si el producto ya existe para actualizarlo
        const productoExistenteIndex = productos.findIndex(p => p.codigo_producto === codigo);

        if (productoExistenteIndex !== -1) {
            // Actualizar producto existente
            productos[productoExistenteIndex].cantidad = (parseInt(productos[productoExistenteIndex].cantidad) + cantidadNum);

            // Actualizar la fila en la tabla
            const filaExistente = document.querySelector(`tr[data-codigo="${codigo}"]`);
            if (filaExistente) {
                filaExistente.querySelector(".cantidad-cell").textContent = productos[productoExistenteIndex].cantidad;
            }
        } else {
            // Agregar nuevo producto
            productos.push({
                codigo_producto: codigo,
                nombre_producto: nombre,
                cantidad: cantidadNum,
                precio_venta: precio,
                metodo_pago: metodoPago,
                sector: sector
            });

            // Crear nueva fila en la tabla
            let tabla = document.getElementById("tablaProductos");
            let fila = document.createElement("tr");
            fila.dataset.codigo = codigo;

            fila.innerHTML = `
            <td>${nombre}</td>
            <td class="cantidad-cell">${cantidadNum}</td>
            <td class="precio-cell">${precio}</td>
            <td class="metodo-pago-cell">${metodoPago}</td>
            <td>
                <button class="btn btn-warning btn-sm me-1 editar">✏️ Editar</button>
                <button class="btn btn-danger btn-sm eliminar">❌ Eliminar</button>
            </td>
        `;

            tabla.appendChild(fila);

            // Agregar eventos a los botones
            fila.querySelector(".editar").addEventListener("click", function () {
                editarProducto(fila, codigo);
            });

            fila.querySelector(".eliminar").addEventListener("click", function () {
                Swal.fire({
                    title: '¿Está seguro?',
                    text: "Este producto será eliminado de la lista.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, eliminar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        productos = productos.filter(p => p.codigo_producto !== codigo);
                        fila.remove();
                        Swal.fire({
                            icon: 'success',
                            title: 'Eliminado',
                            text: 'El producto ha sido eliminado.'
                        });
                        actualizarTotales();
                    }
                });
            });
        }

        // Limpiar campos
        document.getElementById("nombreProducto").value = "";
        document.getElementById("cantidad").value = "";
        document.getElementById("precio").value = "";
        document.getElementById("metodoPago").value = "";

        actualizarTotales();
    });

    // Función para editar producto (única versión)
    function editarProducto(fila, codigo) {
        // Obtener el producto para validar stock
        const producto = productos.find(p => p.codigo_producto === codigo);
        const selectedOption = document.querySelector(`#nombreProducto option[value="${codigo}"]`);
        const stockTotal = selectedOption ? parseInt(selectedOption.dataset.stock) : 0;

        // Obtener los valores actuales
        const cantidadCell = fila.querySelector(".cantidad-cell");
        const precioCell = fila.querySelector(".precio-cell");
        const metodoPagoCell = fila.querySelector(".metodo-pago-cell");
        const cantidadActual = cantidadCell.textContent;
        const precioActual = precioCell.textContent;
        const metodoPagoActual = metodoPagoCell.textContent.trim();

        // Convertir celdas en campos editables
        cantidadCell.innerHTML = `<input type="number" class="form-control form-control-sm edit-cantidad" value="${cantidadActual}" min="1" max="${stockTotal}">`;
        precioCell.innerHTML = `<input type="number" class="form-control form-control-sm edit-precio" value="${precioActual}" min="0.01" step="0.01">`;

        // Crear select para método de pago
        const metodosPago = ['Efectivo', 'Tarjeta', 'Transferencia'];
        let options = metodosPago.map(mp =>
            `<option value="${mp}" ${mp === metodoPagoActual ? 'selected' : ''}>${mp}</option>`
        ).join('');

        metodoPagoCell.innerHTML = `
        <select class="form-select form-select-sm edit-metodo-pago">
            ${options}
        </select>
    `;

        // Cambiar botón de editar a guardar
        const btnEditar = fila.querySelector(".editar");
        btnEditar.innerHTML = "💾 Guardar";
        btnEditar.classList.remove("btn-warning");
        btnEditar.classList.add("btn-success");

        // Remover el evento anterior y agregar el de guardar
        btnEditar.replaceWith(btnEditar.cloneNode(true));
        fila.querySelector(".editar").addEventListener("click", function () {
            guardarEdicion(fila, codigo, stockTotal);
        });
    }

    // Función para guardar los cambios
    function guardarEdicion(fila, codigo, stockTotal) {
        const nuevaCantidad = parseInt(fila.querySelector(".edit-cantidad").value);
        const nuevoPrecio = parseFloat(fila.querySelector(".edit-precio").value);
        const nuevoMetodoPago = fila.querySelector(".edit-metodo-pago").value;

        // Validar los valores
        if (!nuevaCantidad || nuevaCantidad < 1 || !nuevoPrecio || nuevoPrecio <= 0) {
            Swal.fire({
                icon: 'error',
                title: 'Valores inválidos',
                text: 'La cantidad debe ser al menos 1 y el precio debe ser mayor a 0'
            });
            return;
        }

        // Validar stock (considerando otros productos en el carrito)
        const cantidadOriginal = parseInt(fila.querySelector(".edit-cantidad").defaultValue);
        const cantidadReservada = productos.reduce((total, p) => {
            return p.codigo_producto === codigo ? total + parseInt(p.cantidad, 10) : total;
        }, 0);

        const stockDisponible = stockTotal - (cantidadReservada - cantidadOriginal);

        if (nuevaCantidad > stockDisponible) {
            Swal.fire({
                icon: 'error',
                title: 'Stock insuficiente',
                html: `No hay suficiente stock. Disponible: ${stockDisponible}`
            });
            return;
        }

        // Actualizar la fila
        fila.querySelector(".cantidad-cell").textContent = nuevaCantidad;
        fila.querySelector(".precio-cell").textContent = nuevoPrecio.toFixed(2);
        fila.querySelector(".metodo-pago-cell").textContent = nuevoMetodoPago;

        // Actualizar el array de productos
        const productoIndex = productos.findIndex(p => p.codigo_producto === codigo);
        if (productoIndex !== -1) {
            productos[productoIndex].cantidad = nuevaCantidad;
            productos[productoIndex].precio_venta = nuevoPrecio;
            productos[productoIndex].metodo_pago = nuevoMetodoPago;
        }

        // Restaurar botón de editar
        const btnGuardar = fila.querySelector(".editar");
        btnGuardar.innerHTML = "✏️ Editar";
        btnGuardar.classList.remove("btn-success");
        btnGuardar.classList.add("btn-warning");

        // Volver a asignar el evento de editar
        btnGuardar.replaceWith(btnGuardar.cloneNode(true));
        fila.querySelector(".editar").addEventListener("click", function () {
            editarProducto(fila, codigo);
        });

        // Actualizar totales
        actualizarTotales();
    }


    document.getElementById("guardarVenta").addEventListener("click", async function () {
        if (productos.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Sin productos',
                text: 'No se han agregado productos.'
            });
            return;
        }

        try {
            
            // Calcular total
            const detallesVenta = productos.map(producto => ({
                codigo_producto: producto.codigo_producto,
                cantidad: parseInt(producto.cantidad, 10),
                precio_unitario: parseFloat(producto.precio_venta),
                metodo_pago: producto.metodo_pago,
                sector: producto.sector
            }));

            const totalVenta = detallesVenta.reduce((total, producto) => {
                return total + (producto.cantidad * producto.precio_unitario);
            }, 0).toFixed(2);

            const codigoVenta = document.getElementById("codigoVenta").value;

            // Enviar los datos de la venta
            const response = await fetch("http://localhost:4000/ventas/api/ventas", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    detalles_venta: detallesVenta,
                    estado_venta: 'Completada'
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                // Extraer el nombre del producto del mensaje de error (asumiendo que está disponible)
                const productoError = productos.find(p => p.codigo_producto == errorData.message.match(/producto (\d+)/)[1]);
                const nombreProducto = productoError ? productoError.nombre_producto : 'el producto';

                throw new Error(errorData.message
                    ? `Mercancía insuficiente para ${nombreProducto}. Disponible: ${errorData.message.match(/Disponible: (\d+)/)[1]}, solicitado: ${errorData.message.match(/solicitado: (\d+)/)[1]}`
                    : `Error HTTP: ${response.status}`);
            }

            const result = await response.json();

            // Mostrar SweetAlert con el código de venta
            Swal.fire({
                icon: 'success',
                title: 'Venta registrada',
                text: `✅ Venta registrada exitosamente`  // Asegúrate de que el código de venta se obtenga correctamente
            });

            // Resetear la venta
            productos = [];
            document.getElementById("tablaProductos").innerHTML = "";

            if (codigoVenta) {
                localStorage.setItem("ultimaVenta", result.codigo_venta);  // Usa result.codigo_venta
                cargarCodigoVenta();
                cargarHistorialVentas();
                actualizarTotales();
            }

        } catch (error) {
            console.error("Error en el proceso:", error);
            Swal.fire({
                icon: 'warning',  // Cambiado de 'error' a 'warning'
                title: 'Atención', // Cambiado el título
                text: error.message.replace('Stock', 'Mercancía') // Reemplazamos "Stock" por "Mercancía"
            });
        }
    });


    fetch("http://localhost:4000/ventas/api/ventas/")
        .then(response => response.json())
        .then(data => {
            console.log(data);
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
        });

    fetch('/api/empleados')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const empleado = data.empleado;
                const empleadoInput = document.getElementById('empleado');
                empleadoInput.value = `${empleado.Nombre} ${empleado.Apellido}`;
            } else {
                console.log(data.message);
            }
        })
        .catch(error => console.error('Error al obtener datos del empleado:', error));

    function actualizarTotales() {
        let subtotal = 0;

        // Calcular subtotal sumando todos los productos
        productos.forEach(producto => {
            subtotal += parseFloat(producto.precio_venta) * parseInt(producto.cantidad);
        });

        const iva = subtotal * 0.15;
        const total = subtotal + iva;

        // Actualizar los campos
        document.getElementById("subtotal").value = subtotal.toFixed(2);
        document.getElementById("iva").value = iva.toFixed(2);
        document.getElementById("total").value = total.toFixed(2);
    }

    function cargarHistorialVentas() {
        // Primero obtenemos todos los productos
        fetch('http://localhost:4000/productos/api/productos/')
            .then(response => response.json())
            .then(productosData => {
                if (!productosData.success) throw new Error('Error al cargar productos');

                const productos = productosData.data;
                const mapaProductos = {};
                productos.forEach(p => {
                    mapaProductos[p.Cod_Producto] = p.Nombre;
                });

                // Ahora obtenemos el historial de ventas
                fetch('http://localhost:4000/ventas/api/ventas/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const ventas = data.data;
                            const tbody = document.getElementById('tablaHistorialVentas');
                            tbody.innerHTML = '';

                            ventas.forEach(venta => {
                                const fecha = new Date(venta.Fecha_Salida);
                                const fechaFormateada = `${fecha.getDate().toString().padStart(2, '0')}/${(fecha.getMonth() + 1).toString().padStart(2, '0')}/${fecha.getFullYear()}`;
                                const nombreProducto = mapaProductos[venta.Cod_Producto] || 'Desconocido';

                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                <td>${venta.Cod_Venta}</td>
                <td>${nombreProducto}</td>
                <td>${venta.Cantidad_Venta}</td>
                <td>$${venta.Precio_Venta.toFixed(2)}</td>
                <td>${venta.Metodo_Pago}</td>
                <td>${venta.Sector}</td>
                <td>${fechaFormateada}</td>
              `;
                                tbody.appendChild(tr);
                            });
                        } else {
                            console.error('Error al cargar ventas:', data);
                        }
                    })
                    .catch(err => console.error('Error al cargar ventas:', err));
            })
            .catch(err => console.error('Error al cargar productos:', err));
    }

    // Ejecutar al cargar la página
    document.addEventListener('DOMContentLoaded', cargarHistorialVentas);

    async function cargarCodigoVenta() {
        try {
            const response = await fetch('http://localhost:4000/ventas/api/ventas/');
            const data = await response.json();

            if (data.success && Array.isArray(data.data)) {
                const ventas = data.data;

                // Buscar el código máximo (asumiendo que la clave es Cod_Venta)
                const ultimoCodigo = ventas.reduce((max, venta) => {
                    return venta.Cod_Venta > max ? venta.Cod_Venta : max;
                }, 0);

                const nuevoCodigo = ultimoCodigo + 1;
                document.getElementById("codigoVenta").value = nuevoCodigo;
                localStorage.setItem("codigoVenta", nuevoCodigo); // Si deseas guardarlo
            } else {
                throw new Error("No se pudo obtener la lista de ventas");
            }
        } catch (error) {
            console.error("Error al cargar el código de venta:", error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo obtener el código de venta desde el servidor'
            });
        }
    }

    async function cargarSectores() {
        try {
            const response = await fetch("http://localhost:4000/productos/api/productos");
            const data = await response.json();

            if (data.success) {
                const sectoresUnicos = [...new Set(data.data.map(producto => producto.Sector))];
                const selectSector = document.getElementById("sector");

                selectSector.innerHTML = `<option value="" disabled selected>Seleccione un sector</option>`;
                sectoresUnicos.forEach(sector => {
                    const option = document.createElement("option");
                    option.value = sector;
                    option.textContent = sector;
                    selectSector.appendChild(option);
                });
            }
        } catch (error) {
            console.error("Error al cargar sectores:", error);
        }
    }

    // Llamar al cargar la página
    document.addEventListener("DOMContentLoaded", () => {
        cargarCodigoVenta();
        cargarSectores(); // Esto ya lo tienes
        actualizarTotales();
    });

    // En la función cargarProductosPorSector, modificar la creación de options para guardar también el nombre:
    function cargarProductosPorSector(sectorSeleccionado) {
        fetch("http://localhost:4000/productos/api/productos")
            .then(response => response.json())
            .then(data => {
                const selectProducto = document.getElementById("nombreProducto");
                selectProducto.innerHTML = '<option value="" disabled selected>Seleccione un producto</option>';

                data.data.forEach(producto => {
                    if (producto.Sector === sectorSeleccionado) {
                        const option = document.createElement("option");
                        option.value = producto.Cod_Producto;
                        option.textContent = producto.Nombre;
                        option.dataset.nombre = producto.Nombre;
                        option.dataset.precio = producto.Precio_Compra;
                        option.dataset.stock = producto.Cantidad; // Asegúrate que esto tenga el valor correcto (46 en tu caso)
                        option.dataset.vencimiento = producto.FechaVencimiento;
                        selectProducto.appendChild(option);
                    }
                });
            });
    }

    document.getElementById("nombreProducto").addEventListener("change", function () {
        const productoSeleccionado = this.selectedOptions[0];
        const precio = productoSeleccionado.dataset.precio;
        const precioConIVA = (precio * 1.25).toFixed(2);
        document.getElementById("precio").value = precioConIVA;
    });

    document.getElementById("sector").addEventListener("change", function () {
        const sectorSeleccionado = this.value;
        cargarProductosPorSector(sectorSeleccionado);
    });

    // Función para verificar si un producto está vencido
    function productoEstaVencido(fechaVencimiento) {
        if (!fechaVencimiento) return false;
        const hoy = new Date();
        const vencimiento = new Date(fechaVencimiento);
        return vencimiento < hoy;
    }

</script>