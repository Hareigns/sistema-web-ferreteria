<title>Gesti√≥n de Productos</title>
<link rel="stylesheet" href="/styles/productos.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>


<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="#">
      <i class="fas fa-boxes me-2"></i>Gesti√≥n de Productos
    </a>
  </div>
</nav>

<div class="container mt-4">
  <!-- Pesta√±as -->
  <ul class="nav nav-tabs" id="productTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button"
        role="tab" aria-controls="inventory" aria-selected="true">
        <i class="fas fa-clipboard-list me-2"></i>Inventario
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button"
        role="tab" aria-controls="register" aria-selected="false">
        <i class="fas fa-plus-circle me-2"></i>Registrar Productos
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="modify-tab" data-bs-toggle="tab" data-bs-target="#modify" type="button" role="tab"
        aria-controls="modify" aria-selected="false">
        <i class="fas fa-edit me-2"></i>Actualizar Productos
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="outlet-tab" data-bs-toggle="tab" data-bs-target="#outlet" type="button" role="tab"
        aria-controls="outlet" aria-selected="false">
        <i class="fas fa-minus-circle me-2"></i>Registrar Bajas
      </button>
    </li>
  </ul>

  <!-- Contenido de las pesta√±as -->
  <div class="tab-content" id="productTabsContent">

    <!-- Pesta√±a de Inventario -->
    <div class="tab-pane fade show active" id="inventory" role="tabpanel" aria-labelledby="inventory-tab">
      <div class="card">
        <div class="card-header">
          <h3 class="text-center mb-0"><i class="fas fa-clipboard-list me-2"></i>Inventario de Productos</h3>
        </div>
        <div class="card-body p-4">
          <div class="table-responsive">
            <table class="table align-middle mb-0 bg-white display" id="productosTable" style="width:100%">
              <thead class="bg-light">
                <tr>
                  <th>Imagen</th>
                  <th>C√≥digo</th>
                  <th>Nombre</th>
                  <th>Sector</th>
                  <th>Marca</th>
                  <th>Ubicaci√≥n</th>
                  <th>Cantidad</th>
                  <th>Precio</th>
                  <th>Vencimiento</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                <!-- DataTables llenar√° esto autom√°ticamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Pesta√±a de Registro -->
    <div class="tab-pane fade" id="register" role="tabpanel" aria-labelledby="register-tab">
      <div class="card">
        <div class="card-header">
          <h3 class="text-center mb-0"><i class="fas fa-plus-circle me-2"></i>Registro de Productos</h3>
        </div>
        <div class="card-body p-4">
          <form id="form-producto">
            <!-- Fila 1: C√≥digo y Nombre -->
            <div class="row g-3">
              <div class="col-md-6">
                <div class="floating-label">
                  <label for="codigo_producto">C√≥digo Producto</label>
                  <input type="text" id="codigo_producto" name="codigo_producto" class="form-control" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="floating-label">
                  <label for="nombre">Nombre del Producto</label>
                  <input type="text" id="nombre" name="nombre" class="form-control" required>
                </div>
              </div>
            </div>

            <!-- Fila 2: Sector y Proveedor -->
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <div class="floating-label">
                  <label for="sector">Sector</label>
                  <select id="sector" name="sector" class="form-select" required>
                    <option value="" disabled selected>Seleccione un sector</option>
                    <option value="Herramientas manuales">Herramientas manuales</option>
                    <option value="Herramientas el√©ctricas">Herramientas el√©ctricas</option>
                    <option value="Materiales de construcci√≥n">Materiales de construcci√≥n</option>
                    <option value="Pinturas o accesorios">Pinturas o accesorios</option>
                    <option value="Tuber√≠as y plomer√≠a">Tuber√≠as y plomer√≠a</option>
                    <option value="Electricidad e iluminaci√≥n">Electricidad e iluminaci√≥n</option>
                    <option value="Seguridad industrial">Seguridad industrial</option>
                    <option value="Productos de ferreter√≠a general">Productos de ferreter√≠a general</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="floating-label">
                  <label for="codigo_proveedor">Proveedor</label>
                  <select id="codigo_proveedor" name="codigo_proveedor" class="form-select" required disabled>
                    <option value="" disabled selected>Cargando proveedores...</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Fila 3: Precio y Cantidad -->
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <div class="floating-label">
                  <label for="precio_compra">Precio Compra</label>
                  <input type="number" id="precio_compra" name="precio_compra" class="form-control" step="0.01" min="0"
                    required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="floating-label">
                  <label for="cantidad">Cantidad</label>
                  <input type="number" id="cantidad" name="cantidad" class="form-control" min="1" required>
                </div>
              </div>
            </div>

            <!-- Fila 4: Marca y Ubicaci√≥n -->
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <div class="floating-label">
                  <label for="marca">Marca</label>
                  <input type="text" id="marca" name="marca" class="form-control" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="floating-label">
                  <label for="ubicacion">Ubicaci√≥n en Almac√©n</label>
                  <select id="ubicacion" name="ubicacion" class="form-select" required>
                    <option value="" disabled selected>Seleccione una ubicaci√≥n</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Fila 5: Fechas -->
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <div class="floating-label">
                  <label for="fecha_entrada">Fecha Entrada</label>
                  <input type="date" id="fecha_entrada" name="fecha_entrada" class="form-control" disabled>
                </div>
              </div>
              <div class="col-md-6">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-check mt-3">
                      <input class="form-check-input" type="checkbox" id="check_vencimiento">
                      <label class="form-check-label" for="check_vencimiento">Ingresar Fecha de Vencimiento</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="floating-label">
                      <label for="fecha_vencimiento">Fecha Vencimiento</label>
                      <input type="date" id="fecha_vencimiento" name="fecha_vencimiento" class="form-control" disabled>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Fila 6: Subir im√°genes -->
            <div class="row g-3 mt-2">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-camera me-2"></i>Imagen del Producto</h6>
                  </div>
                  <div class="card-body">
                    <!-- √Årea de arrastrar y soltar -->
                    <div class="drop-zone" id="dropZone">
                      <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                      <h5>Arrastra y suelta tu imagen aqu√≠</h5>
                      <p class="text-muted">o haz clic para seleccionar</p>
                      <input type="file" id="imagen_producto" name="imagen_producto" class="d-none" accept="image/*"
                        capture="camera">
                      <button type="button" class="btn btn-outline-primary mt-2"
                        onclick="document.getElementById('imagen_producto').click()">
                        <i class="fas fa-folder-open me-2"></i>Seleccionar Archivo
                      </button>
                      <button type="button" class="btn btn-outline-success mt-2" onclick="takePhoto()">
                        <i class="fas fa-camera me-2"></i>Tomar Foto
                      </button>
                    </div>

                    <!-- Vista previa -->
                    <div id="preview-container" class="mt-3 text-center" style="display: none;">
                      <h6>Vista Previa:</h6>
                      <div class="position-relative d-inline-block">
                        <img id="preview-image" src="#" alt="Vista previa" class="img-thumbnail preview-image"
                          style="max-width: 200px; max-height: 200px;">
                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1"
                          onclick="limpiarImagenRegistro()" title="Eliminar imagen">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                      <div class="mt-2">
                        <small class="text-muted" id="file-info"></small>
                      </div>
                      <div class="mt-2">
                        <small class="text-success">
                          <i class="fas fa-check-circle me-1"></i>
                          Imagen lista para ser guardada en Supabase
                        </small>
                      </div>
                    </div>

                    <!-- Informaci√≥n -->
                    <div class="mt-3">
                      <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Formatos: JPG, PNG, GIF, WebP ‚Ä¢ Tama√±o m√°ximo: 2MB ‚Ä¢ Las im√°genes se guardan en la nube
                        (Supabase)
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bot√≥n Agregar -->
            <div class="text-center mt-3">
              <button id="agregarProducto" type="button" class="btn btn-success">
                <i class="fas fa-plus-circle me-2"></i>Agregar a Lista
              </button>
            </div>

            <!-- Lista Temporal -->
            <div class="mt-4">
              <h5 class="text-center" style="background-color: #80c7e0; color: #fff; padding: 8px; border-radius: 5px;">
                Lista de Productos a Registrar
              </h5>
              <table class="table table-light table-striped text-center">
                <thead class="table-secondary">
                  <tr>
                    <th>C√≥digo</th>
                    <th>Nombre</th>
                    <th>Sector</th>
                    <th>Marca</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                    <th>Vencimiento</th>
                    <th>Ubicaci√≥n</th>
                    <th>Imagen</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tablaProductosTemp">
                  <!-- Aqu√≠ se agregar√°n din√°micamente los productos antes de guardar -->
                </tbody>
              </table>
            </div>

            <!-- Botones Guardar y Limpiar -->
            <div class="d-flex justify-content-between mt-3">
              <button id="guardarProductos" type="button" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Guardar Productos
              </button>
              <button type="reset" class="btn btn-secondary">
                <i class="fas fa-broom me-2"></i>Limpiar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Pesta√±a de Modificaci√≥n -->
    <div class="tab-pane fade" id="modify" role="tabpanel" aria-labelledby="modify-tab">
      <div class="card">
        <div class="card-header">
          <h3 class="text-center mb-0"><i class="fas fa-edit me-2"></i>Actualizar Productos</h3>
        </div>
        <div class="card-body p-4">
          <!-- Selector de producto -->
          <div class="row mb-4">
            <div class="col-md-8">
              <div class="floating-label">
                <label for="select_producto_modificar">Buscar producto a modificar</label>
                <select id="select_producto_modificar" class="form-select select2-search"
                  onchange="cargarDatosProducto(this.value)">
                  <option value="" disabled selected>Escriba c√≥digo, nombre o marca del producto...</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Formulario de modificaci√≥n -->
          <div id="formulario-modificacion" style="display: none;">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i> Solo los campos marcados con <span class="text-primary">*</span>
              son editables.
            </div>

            <div class="row g-3">
              <!-- Columna izquierda: Datos del producto -->
              <div class="col-md-8">
                <div class="row g-3">
                  <!-- Fila 1: C√≥digo y Nombre -->
                  <div class="col-md-6">
                    <div class="floating-label">
                      <label for="mod_codigo_producto">C√≥digo Producto</label>
                      <input type="text" id="mod_codigo_producto" class="form-control" readonly
                        style="background-color: #f8f9fa;">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="floating-label">
                      <label for="mod_nombre">Nombre del Producto</label>
                      <input type="text" id="mod_nombre" class="form-control" readonly
                        style="background-color: #f8f9fa;">
                    </div>
                  </div>

                  <!-- Fila 2: Sector y Proveedor -->
                  <div class="col-md-6">
                    <div class="floating-label">
                      <label for="mod_sector">Sector</label>
                      <input type="text" id="mod_sector" class="form-control" readonly
                        style="background-color: #f8f9fa;">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="floating-label">
                      <label for="mod_codigo_proveedor">Proveedor</label>
                      <input type="text" id="mod_codigo_proveedor" class="form-control" readonly
                        style="background-color: #f8f9fa;">
                    </div>
                  </div>

                  <!-- Fila 3: Precio y Cantidad -->
                  <div class="col-md-6">
                    <div class="floating-label">
                      <label for="mod_precio_compra">Nuevo Precio Compra <span class="text-primary">*</span></label>
                      <input type="number" id="mod_precio_compra" class="form-control" step="0.01" min="0.01"
                        placeholder="Ingrese nuevo precio">
                      <div id="mod_precio_base_info" class="mt-2 small text-muted"></div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="floating-label">
                      <label for="mod_cantidad">Cantidad a Agregar <span class="text-primary">*</span></label>
                      <input type="number" id="mod_cantidad" class="form-control" min="1"
                        placeholder="Ingrese cantidad a agregar">
                      <div id="mod_inventario_info" class="mt-2 small text-muted"></div>
                    </div>
                  </div>

                  <!-- Fila 4: Marca y Ubicaci√≥n -->
                  <div class="col-md-6">
                    <div class="floating-label">
                      <label for="mod_marca">Marca</label>
                      <input type="text" id="mod_marca" class="form-control" readonly
                        style="background-color: #f8f9fa;">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="floating-label">
                      <label for="mod_ubicacion">Ubicaci√≥n en Almac√©n <span class="text-primary">*</span></label>
                      <select id="mod_ubicacion" class="form-select">
                        <option value="" disabled selected>Seleccione una ubicaci√≥n</option>
                      </select>
                    </div>
                  </div>

                  <!-- Fila 5: Fechas -->
                  <div class="col-md-6">
                    <div class="floating-label">
                      <label for="mod_fecha_entrada">Fecha Entrada</label>
                      <input type="date" id="mod_fecha_entrada" class="form-control" readonly
                        style="background-color: #f8f9fa;">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="floating-label">
                      <label for="mod_fecha_vencimiento">Fecha Vencimiento <span class="text-primary">*</span></label>
                      <input type="date" id="mod_fecha_vencimiento" class="form-control">
                      <small class="text-muted">Dejar vac√≠o si no tiene fecha de vencimiento</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Columna derecha: Imagen del producto -->
              <div class="col-md-4">
                <div class="card h-100">
                  <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-camera me-2"></i>Imagen del Producto</h6>
                  </div>
                  <div class="card-body text-center">
                    <!-- Imagen actual -->
                    <div id="mod_imagen_actual_container">
                      <img id="mod_imagen_actual" src="" alt="Imagen actual del producto" class="img-thumbnail mb-3"
                        style="max-width: 200px; max-height: 200px; display: none; cursor: pointer;"
                        onclick="ampliarImagenActual()">
                      <div id="mod_sin_imagen" class="text-muted">
                        <i class="fas fa-image fa-3x mb-2"></i>
                        <p>Sin imagen</p>
                      </div>
                    </div>

                    <!-- Bot√≥n para cambiar imagen -->
                    <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2"
                      onclick="document.getElementById('mod_nueva_imagen').click()">
                      <i class="fas fa-sync-alt me-2"></i>Cambiar Imagen
                    </button>

                    <input type="file" id="mod_nueva_imagen" class="d-none" accept="image/*" capture="camera"
                      onchange="procesarNuevaImagenModificar(this.files[0])">

                    <!-- Vista previa nueva imagen -->
                    <div id="mod_preview_nueva_imagen" class="mt-3" style="display: none;">
                      <h6>Nueva imagen:</h6>
                      <div class="position-relative d-inline-block">
                        <img id="mod_preview_image" src="#" alt="Vista previa" class="img-thumbnail"
                          style="max-width: 150px; max-height: 150px;">
                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1"
                          onclick="cancelarCambioImagen()" title="Cancelar cambio">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </div>

                    <!-- Informaci√≥n -->
                    <div class="mt-3">
                      <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Formatos: JPG, PNG, GIF, WebP ‚Ä¢ M√°x: 2MB
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="row mt-4">
              <div class="col-md-6">
                <button class="btn btn-success w-100" type="button" id="modificarProductoButton"
                  onclick="validarYModificarProducto()">
                  <i class="fas fa-save me-2"></i>Guardar Cambios del Producto
                </button>
              </div>
              <div class="col-md-6">
                <button class="btn btn-primary w-100" type="button" id="actualizarImagenButton"
                  onclick="actualizarSoloImagen()" style="display: none;">
                  <i class="fas fa-camera me-2"></i>Actualizar Solo Imagen
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pesta√±a de Bajas -->
    <div class="tab-pane fade" id="outlet" role="tabpanel" aria-labelledby="outlet-tab">
      <div class="card">
        <div class="card-header bg-danger text-white">
          <h3 class="text-center mb-0"><i class="fas fa-minus-circle me-2"></i>Registro de Bajas</h3>
        </div>
        <div class="card-body p-4">
          <form id="bajaForm">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="floating-label">
                  <label for="product_id">Producto</label>
                  <select class="form-select select2-search" id="product_id" name="product_id" required>
                    <option value="" disabled selected>Cargando productos...</option>
                  </select>
                </div>
              </div>

              <div class="col-md-6">
                <div class="floating-label">
                  <label for="quantity">Cantidad</label>
                  <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
                  <div class="form-text">Inventario disponible: <span id="stock-display">0</span></div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="floating-label">
                  <label for="reason">Motivo</label>
                  <select class="form-select" name="reason" id="reason" required>
                    <option value="" disabled selected>Seleccionar...</option>
                    <option value="Devoluci√≥n a proveedor">Devoluci√≥n a proveedor</option>
                    <option value="Producto Da√±ado">Producto da√±ado</option>
                    <option value="Producto Vencido">Producto vencido</option>
                    <option value="Producto oxidado o deteriorado">Producto oxidado o deteriorado</option>
                    <option value="Uso interno">Uso interno</option>
                    <option value="P√©rdida o robo">P√©rdida o robo</option>
                    <option value="Otro">Otro Motivo</option>
                  </select>
                </div>
              </div>

              <div class="col-md-6">
                <div class="floating-label">
                  <label for="notes">Observaciones (opcional)</label>
                  <textarea class="form-control" name="notes" id="notes" rows="2" disabled
                    placeholder="Seleccione 'Otro Motivo' para habilitar"></textarea>
                </div>
              </div>

              <div class="col-12">
                <button type="submit" class="btn btn-danger w-100">
                  <i class="fas fa-save me-2"></i> Registrar Baja
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/es.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/productos.js"></script>

<script>
  // Variables globales
  let productosTemp = [];
  let productosTable;
  const now = new Date();
  const fechaActual = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;

  // Funci√≥n para obtener el stock actual de un producto (suma de todos los lotes disponibles)
  async function obtenerStockActual(codigoProducto) {
    try {
      const response = await fetch(`/productos/api/stock-producto/${codigoProducto}`);
      const data = await response.json();

      if (data.success) {
        return data.stock || 0;
      } else {
        console.error('Error al obtener stock:', data.message);
        return 0;
      }
    } catch (error) {
      console.error('Error al obtener stock:', error);
      return 0;
    }
  }

  // Configuraci√≥n global de Select2 en espa√±ol
  $(document).ready(function () {
    // Establecer espa√±ol como idioma por defecto
    $.fn.select2.defaults.set('language', 'es');
  });

  // Inicializaci√≥n al cargar la p√°gina
  document.addEventListener("DOMContentLoaded", function () {
    // Configurar fecha de entrada
    document.getElementById('fecha_entrada').value = fechaActual;

    // Event listeners
    document.getElementById('sector').addEventListener('change', cargarProveedores);
    document.getElementById('check_vencimiento').addEventListener('change', toggleFechaVencimiento);
    document.getElementById('agregarProducto').addEventListener('click', agregarProductoTemporal);
    document.getElementById('guardarProductos').addEventListener('click', guardarProductos);

    // Configurar Select2 para ambos selects (bajas y modificaci√≥n) en espa√±ol
    $('.select2-search').select2({
      language: "es",
      placeholder: "Escriba para buscar productos...",
      allowClear: true,
      width: '100%',
      minimumInputLength: 1,
      dropdownParent: $('#modify'),
      sorter: function (data) {
        // Ordenar resultados de forma ascendente (1,2,3...)
        return data.sort(function (a, b) {
          return a.text.localeCompare(b.text);
        });
      }
    });

    // Manejar cambio en motivo de baja
    document.getElementById('reason').addEventListener('change', function () {
      const notesTextarea = document.getElementById('notes');
      if (this.value === 'Otro') {
        notesTextarea.disabled = false;
        notesTextarea.required = true;
        notesTextarea.placeholder = 'Por favor especifique el motivo de baja';
      } else {
        notesTextarea.disabled = true;
        notesTextarea.required = false;
        notesTextarea.placeholder = 'Seleccione "Otro Motivo" para habilitar';
        notesTextarea.value = '';
      }
    });

    // Manejar cambio en select de productos para bajas
    $('#product_id').on('change', function () {
      const selectedOption = $(this).find('option:selected');
      const stock = selectedOption.data('stock') || 0;
      $('#stock-display').text(stock);
      $('#quantity').attr('max', stock);
    });

    // Manejar env√≠o del formulario de bajas
    document.getElementById('bajaForm').addEventListener('submit', registrarBaja);

    // Cargar datos iniciales
    cargarProductos();
    cargarSelectProductos();
    cargarProductosParaBajas();
    generarOpcionesUbicacion();
  });

  // Funci√≥n para generar opciones de ubicaci√≥n (compartida para ambos formularios)
  function generarOpcionesUbicacion() {
    const selects = [
      document.getElementById('ubicacion'),
      document.getElementById('mod_ubicacion')
    ];

    selects.forEach(select => {
      if (!select) return;

      // Guardar el valor seleccionado actual si existe
      const currentValue = select.value;
      select.innerHTML = '<option value="" disabled selected>Seleccione una ubicaci√≥n</option>';

      // Generar todas las combinaciones de ubicaci√≥n
      for (let estante = 1; estante <= 8; estante++) {
        for (let repisa = 1; repisa <= 6; repisa++) {
          for (let espacio = 1; espacio <= 4; espacio++) {
            const texto = `Estante ${estante}, Repisa ${repisa}, Espacio ${espacio}`;
            const valor = `E${estante}R${repisa}E${espacio}`;
            const option = new Option(texto, valor);
            select.add(option);
          }
        }
      }

      // Restaurar el valor seleccionado si existe
      if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
        select.value = currentValue;
      }
    });
  }

  // Funci√≥n para alternar el campo de fecha de vencimiento
  function toggleFechaVencimiento() {
    const fechaVencimientoInput = document.getElementById("fecha_vencimiento");
    fechaVencimientoInput.disabled = !this.checked;
    if (!this.checked) fechaVencimientoInput.value = "";
  }

  // Funci√≥n auxiliar para formatear fechas (Aseg√∫rate de que existe)
  function formatDateForInput(dateString) {
    if (!dateString) return '';
    try {
      // Si es una fecha v√°lida, formatearla
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '';

      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');

      return `${year}-${month}-${day}`;
    } catch (e) {
      console.error('Error formateando fecha:', e);
      return '';
    }
  }

  // Funci√≥n para cargar proveedores por sector
  async function cargarProveedores() {
    const sector = this.value;
    const selectProveedor = document.getElementById('codigo_proveedor');

    try {
      selectProveedor.innerHTML = '<option value="" disabled selected>Cargando proveedores...</option>';

      const response = await fetch(`/productos/api/proveedores?sector=${encodeURIComponent(sector)}`);
      const data = await response.json();

      if (data.success) {
        selectProveedor.innerHTML = '<option value="" disabled selected>Seleccione un proveedor</option>';

        data.data.forEach(proveedor => {
          const option = document.createElement('option');
          option.value = proveedor.codigo_proveedor;
          option.textContent = `${proveedor.codigo_proveedor} - ${proveedor.nombre}`;
          selectProveedor.appendChild(option);
        });

        selectProveedor.disabled = false;
      } else {
        throw new Error(data.message || 'Error al cargar proveedores');
      }
    } catch (error) {
      console.error('Error al cargar proveedores:', error);
      selectProveedor.innerHTML = '<option value="" disabled selected>Error al cargar proveedores</option>';
      Swal.fire('Error', 'No se pudieron cargar los proveedores', 'error');
    }
  }

  // Funci√≥n para cargar productos en la tabla principal
  async function cargarProductos(timestamp = null) {
    try {
      const cacheBuster = timestamp || new Date().getTime();
      const response = await fetch(`/productos/api/productos?t=${cacheBuster}`);

      // Verificar si la respuesta es JSON
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('El servidor respondi√≥ con HTML en lugar de JSON');
      }

      const data = await response.json();

      console.log("üìä Datos recibidos para inventario:", {
        cantidad: data.data?.length || 0,
        timestamp: new Date().toLocaleTimeString()
      });

      // CORRECCI√ìN: Solo destruir DataTable si ya existe, pero NO vaciar la tabla
      if ($.fn.DataTable.isDataTable('#productosTable')) {
        productosTable.destroy();
        // NO HACER: $('#productosTable').empty(); // ‚Üê ESTO CAUSA EL PROBLEMA
      }

      if (data.success && Array.isArray(data.data) && data.data.length > 0) {
        const datosOrdenados = data.data.sort((a, b) => {
          const codA = a.cod_producto;
          const codB = b.cod_producto;
          if (!isNaN(codA) && !isNaN(codB)) {
            return parseInt(codA) - parseInt(codB);
          } else {
            return codA.localeCompare(codB);
          }
        });

        // CORRECCI√ìN: Usar clear() y rows.add() en lugar de recrear toda la tabla
        productosTable = $('#productosTable').DataTable({
          data: datosOrdenados,
          columns: [
            {
              data: 'imagen_url_cache',
              render: function (data, type, row) {
                const imageUrl = data || row.imagen_url;

                if (imageUrl) {
                  return `<img src="${imageUrl}" alt="Imagen del producto" 
                  class="img-thumbnail table-image" 
                  style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;"
                  onclick="ampliarImagen('${imageUrl}')"
                  onerror="manejarErrorImagen(this, '${row.cod_producto}')"
                  loading="lazy"
                  data-producto="${row.cod_producto}"
                  data-timestamp="${new Date().getTime()}">`;
                } else {
                  return `<div class="text-center text-muted">
                  <i class="fas fa-image fa-2x"></i>
                  <div class="small">Sin imagen</div>
                </div>`;
                }
              },
              orderable: false,
              width: '80px'
            },
            {
              data: 'cod_producto',
              width: '100px'
            },
            {
              data: 'nombre',
              render: function (data, type, row) {
                return `<strong>${data}</strong>`;
              }
            },
            {
              data: 'sector',
              width: '150px'
            },
            {
              data: 'marca',
              width: '120px'
            },
            {
              data: 'descripcion',
              render: function (data) {
                return data || '<span class="text-muted">Sin ubicaci√≥n</span>';
              },
              width: '150px'
            },
            {
              data: 'cantidad',
              render: function (data) {
                const cantidad = parseInt(data) || 0;
                const badgeClass = cantidad > 10 ? 'bg-success' : cantidad > 0 ? 'bg-warning' : 'bg-danger';
                return `<span class="badge ${badgeClass}">${cantidad}</span>`;
              },
              width: '100px'
            },
            {
              data: 'precio_compra',
              render: function (data) {
                return data ? `C$${parseFloat(data).toFixed(2)}` : '<span class="text-muted">C$0.00</span>';
              },
              width: '100px'
            },
            {
              data: 'fechavencimiento',
              render: function (data) {
                if (!data) return "<span class='text-muted'>N/A</span>";

                const fecha = new Date(data);
                const hoy = new Date();
                const diferencia = fecha - hoy;
                const dias = Math.ceil(diferencia / (1000 * 60 * 60 * 24));

                let badgeClass = 'bg-secondary';
                if (dias < 0) {
                  badgeClass = 'bg-danger';
                } else if (dias <= 30) {
                  badgeClass = 'bg-warning';
                } else if (dias <= 90) {
                  badgeClass = 'bg-info';
                }

                return `<span class="badge ${badgeClass}">
                      ${fecha.getDate().toString().padStart(2, '0')}/${(fecha.getMonth() + 1).toString().padStart(2, '0')}/${fecha.getFullYear()}
                    </span>`;
              },
              width: '120px'
            },
            {
              data: 'estado',
              render: function (data) {
                const estado = data || 'Activo';
                const badgeClass = estado === 'Activo' ? 'bg-success' : 'bg-danger';
                return `<span class="badge ${badgeClass}">${estado}</span>`;
              },
              width: '100px'
            }
          ],
          paging: true,
          searching: true,
          ordering: true,
          order: [[1, 'asc']], // ORDENAR por la segunda columna (c√≥digo) de forma ascendente
          pageLength: 10,
          lengthMenu: [[5, 10, 25, 50, 100], [5, 10, 25, 50, 100]],
          language: {
            "decimal": "",
            "emptyTable": "No hay productos registrados",
            "info": "Mostrando _START_ a _END_ de _TOTAL_ productos",
            "infoEmpty": "Mostrando 0 a 0 de 0 productos",
            "infoFiltered": "(filtrado de _MAX_ productos totales)",
            "infoPostFix": "",
            "thousands": ",",
            "lengthMenu": "Mostrar _MENU_ productos",
            "loadingRecords": "Cargando...",
            "processing": "Procesando...",
            "search": "Buscar:",
            "zeroRecords": "No se encontraron productos coincidentes",
            "paginate": {
              "first": "Primero",
              "last": "√öltimo",
              "next": "Siguiente",
              "previous": "Anterior"
            }
          },
          createdRow: function (row, data, dataIndex) {
            // Resaltar productos con stock bajo
            const cantidad = parseInt(data.cantidad) || 0;
            if (cantidad === 0) {
              $(row).addClass('table-danger');
            } else if (cantidad <= 5) {
              $(row).addClass('table-warning');
            }
          }
        });
      } else {
        // CORRECCI√ìN: Inicializar DataTable vac√≠o sin destruir la estructura
        productosTable = $('#productosTable').DataTable({
          data: [],
          columns: [
            { data: 'imagen_url_cache' },
            { data: 'cod_producto' },
            { data: 'nombre' },
            { data: 'sector' },
            { data: 'marca' },
            { data: 'descripcion' },
            { data: 'cantidad' },
            { data: 'precio_compra' },
            { data: 'fechavencimiento' },
            { data: 'estado' }
          ],
          language: {
            "emptyTable": "No hay productos registrados"
          }
        });
      }
    } catch (error) {
      console.error("Error al cargar productos:", error);

      // Mostrar error espec√≠fico
      let errorMessage = 'Error al cargar los productos';
      if (error.message.includes('HTML')) {
        errorMessage = 'Error del servidor: Respuesta en formato incorrecto';
      }

      // CORRECCI√ìN: Manejar error sin destruir la estructura
      if ($.fn.DataTable.isDataTable('#productosTable')) {
        productosTable.destroy();
      }

      productosTable = $('#productosTable').DataTable({
        data: [],
        columns: [
          { data: 'imagen_url_cache' },
          { data: 'cod_producto' },
          { data: 'nombre' },
          { data: 'sector' },
          { data: 'marca' },
          { data: 'descripcion' },
          { data: 'cantidad' },
          { data: 'precio_compra' },
          { data: 'fechavencimiento' },
          { data: 'estado' }
        ],
        language: {
          "emptyTable": errorMessage
        }
      });

      Swal.fire('Error', errorMessage, 'error');
    }
  }

  // Funci√≥n para ampliar imagen al hacer clic
  function ampliarImagen(src) {
    Swal.fire({
      imageUrl: src,
      imageAlt: 'Imagen del producto',
      showCloseButton: true,
      showConfirmButton: false,
      width: '600px',
      padding: '0',
      background: 'transparent',
      backdrop: `
      rgba(0,0,0,0.8)
      url("/images/zoom-in.png")
      center left
      no-repeat
    `
    });
  }

  // Funci√≥n para ampliar imagen actual en modificaci√≥n
  function ampliarImagenActual() {
    const imgActual = document.getElementById('mod_imagen_actual');
    if (imgActual.style.display !== 'none') {
      Swal.fire({
        imageUrl: imgActual.src,
        imageAlt: 'Imagen actual del producto',
        showCloseButton: true,
        showConfirmButton: false,
        width: '600px'
      });
    }
  }

  // Funci√≥n para cargar productos en el selector de modificaci√≥n (VERSI√ìN CORREGIDA CON ORDEN)
  async function cargarSelectProductos() {
    try {
      const response = await fetch('/productos/api/productos-select');
      const data = await response.json();
      const select = document.getElementById('select_producto_modificar');

      if (!select) return;

      // Limpiar opciones existentes
      select.innerHTML = '<option value="" disabled selected>Escriba para buscar productos...</option>';

      if (data.success && data.data && data.data.length > 0) {
        // ORDENAR los productos por c√≥digo de producto de forma num√©rica
        const productosOrdenados = data.data.sort((a, b) => {
          const codA = a.cod_producto;
          const codB = b.cod_producto;

          // Intentar convertir a n√∫meros para ordenamiento num√©rico
          const numA = parseInt(codA);
          const numB = parseInt(codB);

          if (!isNaN(numA) && !isNaN(numB)) {
            return numA - numB; // Orden num√©rico
          } else {
            return codA.localeCompare(codB); // Orden alfab√©tico como fallback
          }
        });

        // Usar un objeto para evitar duplicados por c√≥digo de producto
        const productosUnicos = {};

        productosOrdenados.forEach(producto => {
          if (producto.cod_producto && !productosUnicos[producto.cod_producto]) {
            productosUnicos[producto.cod_producto] = producto;

            const option = document.createElement('option');
            option.value = producto.cod_producto;
            option.textContent = `${producto.cod_producto} - ${producto.nombre}${producto.marca ? ' (' + producto.marca + ')' : ''}`;
            option.dataset.nombre = producto.nombre;
            option.dataset.marca = producto.marca || '';
            select.appendChild(option);
          }
        });

        // Inicializar Select2 con b√∫squeda mejorada y ordenaci√≥n
        $(select).select2({
          language: "es",
          placeholder: "üîç Escriba c√≥digo, nombre o marca del producto...",
          allowClear: true,
          width: '100%',
          minimumInputLength: 1,
          dropdownParent: $('#modify'),
          sorter: function (data) {
            // Ordenar resultados num√©ricamente por c√≥digo de producto
            return data.sort(function (a, b) {
              // Extraer el c√≥digo del texto (primera parte antes del gui√≥n)
              const codigoA = a.text.split(' - ')[0];
              const codigoB = b.text.split(' - ')[0];

              // Intentar convertir a n√∫meros
              const numA = parseInt(codigoA);
              const numB = parseInt(codigoB);

              if (!isNaN(numA) && !isNaN(numB)) {
                return numA - numB; // Orden num√©rico
              } else {
                return codigoA.localeCompare(codigoB); // Orden alfab√©tico como fallback
              }
            });
          },
          matcher: function (params, data) {
            // Si no hay t√©rmino de b√∫squeda, mostrar todos los resultados ordenados
            if ($.trim(params.term) === '') {
              return data;
            }

            // Normalizar t√©rminos de b√∫squeda
            const term = params.term.toLowerCase();

            // Buscar en diferentes campos
            if (data.text.toLowerCase().indexOf(term) > -1) {
              return data;
            }

            // Buscar en atributos data
            if (data.element && (
              (data.element.dataset.nombre && data.element.dataset.nombre.toLowerCase().indexOf(term) > -1) ||
              (data.element.dataset.marca && data.element.dataset.marca.toLowerCase().indexOf(term) > -1)
            )) {
              return data;
            }

            // Si no coincide, no mostrar
            return null;
          }
        });
      } else {
        select.innerHTML = '<option value="" disabled selected>No hay productos disponibles</option>';
      }
    } catch (error) {
      console.error('Error al cargar productos:', error);
      const select = document.getElementById('select_producto_modificar');
      if (select) {
        select.innerHTML = '<option value="" disabled selected>Error al cargar productos</option>';
      }
    }
  }

  // Funci√≥n para cargar productos en el select de bajas (VERSI√ìN CORREGIDA CON ORDEN)
  async function cargarProductosParaBajas() {
    try {
      const response = await fetch('/productos/api/productos-activos');
      const data = await response.json();
      const select = document.getElementById('product_id');

      if (!select) return;

      select.innerHTML = '<option value="" disabled selected>Seleccione un producto</option>';

      if (data.success && data.data && data.data.length > 0) {
        // Filtrar solo productos con cantidad > 0
        const productosDisponibles = data.data.filter(producto => producto.cantidad > 0);

        if (productosDisponibles.length === 0) {
          select.innerHTML = '<option value="" disabled selected>No hay productos disponibles</option>';
          return;
        }

        // ORDENAR num√©ricamente por c√≥digo de producto
        productosDisponibles.sort((a, b) => {
          const codA = a.cod_producto;
          const codB = b.cod_producto;

          const numA = parseInt(codA);
          const numB = parseInt(codB);

          if (!isNaN(numA) && !isNaN(numB)) {
            return numA - numB; // Orden num√©rico
          } else {
            return codA.localeCompare(codB); // Orden alfab√©tico como fallback
          }
        });

        // Agregar opciones al select
        productosDisponibles.forEach(producto => {
          const option = document.createElement('option');
          option.value = producto.cod_producto;
          option.textContent = `${producto.cod_producto} - ${producto.nombre} (Stock: ${producto.cantidad})`;
          option.dataset.stock = producto.cantidad;
          option.dataset.nombre = producto.nombre;
          option.dataset.marca = producto.marca || '';
          select.appendChild(option);
        });

        // Inicializar Select2 con b√∫squeda mejorada y ordenaci√≥n num√©rica
        $(select).select2({
          language: "es",
          placeholder: "Buscar producto...",
          allowClear: true,
          width: '100%',
          sorter: function (data) {
            // Ordenar resultados num√©ricamente por c√≥digo de producto
            return data.sort(function (a, b) {
              // Extraer el c√≥digo del texto (primera parte antes del gui√≥n)
              const codigoA = a.text.split(' - ')[0];
              const codigoB = b.text.split(' - ')[0];

              // Intentar convertir a n√∫meros
              const numA = parseInt(codigoA);
              const numB = parseInt(codigoB);

              if (!isNaN(numA) && !isNaN(numB)) {
                return numA - numB; // Orden num√©rico
              } else {
                return codigoA.localeCompare(codigoB); // Orden alfab√©tico como fallback
              }
            });
          },
          matcher: function (params, data) {
            // Si no hay t√©rmino de b√∫squeda, mostrar todos los resultados
            if ($.trim(params.term) === '') {
              return data;
            }

            // Normalizar t√©rminos de b√∫squeda
            const term = params.term.toLowerCase();

            // Buscar en diferentes campos
            if (data.text.toLowerCase().indexOf(term) > -1) {
              return data;
            }

            // Buscar en atributos data
            if (data.element && (
              (data.element.dataset.nombre && data.element.dataset.nombre.toLowerCase().indexOf(term) > -1) ||
              (data.element.dataset.marca && data.element.dataset.marca.toLowerCase().indexOf(term) > -1)
            )) {
              return data;
            }

            // Si no coincide, no mostrar
            return null;
          }
        });
      } else {
        select.innerHTML = '<option value="" disabled selected>No hay productos disponibles</option>';
      }
    } catch (error) {
      console.error('Error al cargar productos para bajas:', error);
      const select = document.getElementById('product_id');
      if (select) {
        select.innerHTML = '<option value="" disabled selected>Error al cargar productos</option>';
      }
      Swal.fire('Error', 'No se pudieron cargar los productos para bajas', 'error');
    }
  }

  // Variables globales para imagen en modificaci√≥n
  let imagenActualModificar = null;
  let imagenNombreModificar = null;
  let imagenTipoModificar = null;
  let productoSeleccionadoModificar = null;

  // Funci√≥n para cargar datos del producto (actualizada)
  async function cargarDatosProducto(codigoProducto) {
    const formularioMod = document.getElementById('formulario-modificacion');

    if (!codigoProducto) {
      formularioMod.style.display = 'none';
      return;
    }

    productoSeleccionadoModificar = codigoProducto;

    try {
      const response = await fetch(`/productos/api/productos/${codigoProducto}`);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

      const data = await response.json();
      console.log("Datos recibidos del producto:", data);

      if (data.success && data.data) {
        const producto = data.data;

        // Llenar los campos del formulario
        document.getElementById('mod_codigo_producto').value = producto.cod_producto || '';
        document.getElementById('mod_nombre').value = producto.nombre || '';
        document.getElementById('mod_marca').value = producto.marca || '';
        document.getElementById('mod_sector').value = producto.sector || '';

        // Mostrar proveedor
        let proveedorText = 'Sin proveedor';
        if (producto.cod_proveedor && producto.cod_proveedor !== null) {
          if (producto.proveedor_nombre && producto.proveedor_apellido) {
            proveedorText = `${producto.cod_proveedor} - ${producto.proveedor_nombre} ${producto.proveedor_apellido}`;
          } else {
            proveedorText = `${producto.cod_proveedor}`;
          }
        }
        document.getElementById('mod_codigo_proveedor').value = proveedorText;

        // Precio y cantidad
        const precio = producto.precio_compra || 0;
        document.getElementById('mod_precio_compra').value = '';
        document.getElementById('mod_precio_compra').dataset.originalValue = precio;

        document.getElementById('mod_cantidad').value = '';
        document.getElementById('mod_cantidad').dataset.originalValue = '';

        document.getElementById('mod_fecha_entrada').value = formatDateForInput(producto.fecha_entrada) || fechaActual;

        // MOSTRAR INFORMACI√ìN DE INVENTARIO Y PRECIO
        await mostrarInformacionInventario(codigoProducto, precio);

        // Generar opciones de ubicaci√≥n
        generarOpcionesUbicacion();

        // Establecer la ubicaci√≥n actual del producto
        const ubicacionSelect = document.getElementById('mod_ubicacion');
        if (producto.descripcion) {
          const ubicacionExistente = Array.from(ubicacionSelect.options).find(
            opt => opt.value === producto.descripcion
          );

          if (ubicacionExistente) {
            ubicacionSelect.value = producto.descripcion;
            ubicacionSelect.dataset.originalValue = producto.descripcion;
          } else {
            const option = new Option(producto.descripcion, producto.descripcion);
            ubicacionSelect.add(option);
            ubicacionSelect.value = producto.descripcion;
            ubicacionSelect.dataset.originalValue = producto.descripcion;
          }
        } else {
          ubicacionSelect.value = '';
          ubicacionSelect.dataset.originalValue = '';
        }

        // Fecha de vencimiento
        const fechaVencimientoInput = document.getElementById('mod_fecha_vencimiento');
        if (producto.fechavencimiento) {
          fechaVencimientoInput.value = formatDateForInput(producto.fechavencimiento);
          fechaVencimientoInput.dataset.originalValue = formatDateForInput(producto.fechavencimiento);
        } else {
          fechaVencimientoInput.value = '';
          fechaVencimientoInput.dataset.originalValue = '';
        }

        // ‚úÖ CORRECCI√ìN CR√çTICA: Cargar imagen actual del producto
        await cargarImagenActualProducto(codigoProducto, producto.imagen_url);

        // Mostrar el formulario
        formularioMod.style.display = 'block';

      } else {
        throw new Error('No se encontraron datos del producto');
      }
    } catch (error) {
      console.error('Error al cargar datos del producto:', error);
      Swal.fire('Error', 'No se pudieron cargar los datos del producto', 'error');
      formularioMod.style.display = 'none';
    }
  }

  // ‚úÖ NUEVA FUNCI√ìN: Cargar imagen actual del producto
  async function cargarImagenActualProducto(codigoProducto, imagenUrl = null) {
    const imgActual = document.getElementById('mod_imagen_actual');
    const sinImagen = document.getElementById('mod_sin_imagen');
    const btnActualizarImagen = document.getElementById('actualizarImagenButton');

    // Resetear nueva imagen
    cancelarCambioImagen();

    try {
      let urlImagenFinal = null;

      // Si no se proporcion√≥ imagenUrl, obtenerla de la API
      if (!imagenUrl) {
        const response = await fetch(`/productos/api/productos/${codigoProducto}/imagen`);
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.imagen_url) {
            urlImagenFinal = data.imagen_url;
          }
        }
      } else {
        urlImagenFinal = imagenUrl;
      }

      // Aplicar cache busting a la URL
      if (urlImagenFinal) {
        const urlConCache = `${urlImagenFinal}${urlImagenFinal.includes('?') ? '&' : '?'}t=${Date.now()}`;
        imgActual.src = urlConCache;
        imgActual.style.display = 'block';
        sinImagen.style.display = 'none';

        console.log(`‚úÖ Imagen cargada para ${codigoProducto}:`, urlConCache);
      } else {
        imgActual.style.display = 'none';
        sinImagen.style.display = 'block';
        console.log(`‚ÑπÔ∏è Producto ${codigoProducto} sin imagen`);
      }

      // Ocultar bot√≥n de actualizar imagen inicialmente
      btnActualizarImagen.style.display = 'none';

    } catch (error) {
      console.error(`‚ùå Error cargando imagen para ${codigoProducto}:`, error);
      imgActual.style.display = 'none';
      sinImagen.style.display = 'block';
    }
  }

  // Funci√≥n para cancelar cambio de imagen
  function cancelarCambioImagen() {
    imagenActualModificar = null;
    imagenNombreModificar = null;
    imagenTipoModificar = null;

    document.getElementById('mod_preview_nueva_imagen').style.display = 'none';
    document.getElementById('actualizarImagenButton').style.display = 'none';
    document.getElementById('mod_nueva_imagen').value = '';
  }

  // ‚úÖ FUNCI√ìN FALTANTE: Cargar imagen actual despu√©s de actualizar
  function cargarImagenActual(nuevaImagenUrl) {
    const imgActual = document.getElementById('mod_imagen_actual');
    const sinImagen = document.getElementById('mod_sin_imagen');

    if (nuevaImagenUrl) {
      // Agregar cache busting
      const urlConCache = `${nuevaImagenUrl}${nuevaImagenUrl.includes('?') ? '&' : '?'}t=${Date.now()}`;
      imgActual.src = urlConCache;
      imgActual.style.display = 'block';
      sinImagen.style.display = 'none';

      console.log('‚úÖ Imagen actualizada en el formulario:', urlConCache);
    } else {
      imgActual.style.display = 'none';
      sinImagen.style.display = 'block';
    }

    // Limpiar la nueva imagen despu√©s de actualizar
    cancelarCambioImagen();
  }

  // Funci√≥n para actualizar solo la imagen
  async function actualizarSoloImagen() {
    if (!productoSeleccionadoModificar) {
      Swal.fire('Error', 'No hay producto seleccionado', 'error');
      return;
    }

    if (!imagenActualModificar) {
      Swal.fire('Error', 'No hay nueva imagen seleccionada', 'error');
      return;
    }

    try {
      const btnActualizar = document.getElementById('actualizarImagenButton');
      btnActualizar.disabled = true;
      btnActualizar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Actualizando...';

      const response = await fetch(`/productos/api/productos/${productoSeleccionadoModificar}/imagen`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          imagen_base64: imagenActualModificar,
          imagen_nombre: imagenNombreModificar,
          imagen_tipo: imagenTipoModificar
        })
      });

      const result = await response.json();

      if (result.success) {
        await Swal.fire({
          icon: 'success',
          title: 'Imagen actualizada',
          text: 'La imagen del producto se ha actualizado correctamente',
          timer: 3000,
          timerProgressBar: true
        });

        // Actualizar la imagen actual
        cargarImagenActual(result.imagen_url);

        // CORRECCI√ìN: Recargar y reordenar la tabla de inventario
        await recargarYReordenarInventario();

      } else {
        throw new Error(result.message || 'No se pudo actualizar la imagen');
      }
    } catch (error) {
      console.error('Error al actualizar imagen:', error);
      Swal.fire('Error', error.message || 'Error al conectar con el servidor', 'error');
    } finally {
      const btnActualizar = document.getElementById('actualizarImagenButton');
      if (btnActualizar) {
        btnActualizar.disabled = false;
        btnActualizar.innerHTML = '<i class="fas fa-camera me-2"></i>Actualizar Solo Imagen';
      }
    }
  }

  // Funci√≥n para recargar y reordenar el inventario
  async function recargarYReordenarInventario() {
    try {
      // Recargar los datos sin destruir la estructura
      await cargarProductos(new Date().getTime());
      console.log('Inventario recargado y reordenado correctamente');
    } catch (error) {
      console.error('Error al recargar inventario:', error);
    }
  }

  // Funci√≥n para mostrar informaci√≥n del inventario y precio base
  async function mostrarInformacionInventario(codigoProducto, precioActual) {
    try {
      // Obtener stock actual
      const stockActual = await obtenerStockActual(codigoProducto);

      // Mostrar informaci√≥n del inventario
      const inventarioInfo = document.getElementById('mod_inventario_info');
      inventarioInfo.innerHTML = `<strong>Inventario actual:</strong> ${stockActual} unidades`;
      inventarioInfo.style.display = 'block';

      // Mostrar informaci√≥n del precio base (SOLO AQU√ç, no en el campo)
      const precioBaseInfo = document.getElementById('mod_precio_base_info');
      precioBaseInfo.innerHTML = `<strong>Precio base actual:</strong> C$${parseFloat(precioActual).toFixed(2)}`;
      precioBaseInfo.style.display = 'block';

    } catch (error) {
      console.error('Error al mostrar informaci√≥n del inventario:', error);

      // Mostrar informaci√≥n b√°sica incluso si hay error
      const inventarioInfo = document.getElementById('mod_inventario_info');
      inventarioInfo.innerHTML = `<strong>Inventario:</strong> No disponible`;
      inventarioInfo.style.display = 'block';

      const precioBaseInfo = document.getElementById('mod_precio_base_info');
      precioBaseInfo.innerHTML = `<strong>Precio base:</strong> C$${parseFloat(precioActual).toFixed(2)}`;
      precioBaseInfo.style.display = 'block';
    }
  }

  // Funci√≥n para validar antes de modificar
  function validarYModificarProducto() {
    const precio_nuevo = parseFloat(document.getElementById('mod_precio_compra').value);
    const cantidad_nueva = parseInt(document.getElementById('mod_cantidad').value);

    // Validaciones estrictas
    if (isNaN(precio_nuevo) || precio_nuevo <= 0) {
      Swal.fire({
        icon: 'error',
        title: 'Precio inv√°lido',
        text: 'El precio debe ser un n√∫mero mayor a 0. No se permiten valores de 0.'
      });
      document.getElementById('mod_precio_compra').focus();
      return;
    }

    if (isNaN(cantidad_nueva) || cantidad_nueva <= 0) {
      Swal.fire({
        icon: 'error',
        title: 'Cantidad inv√°lida',
        text: 'La cantidad debe ser un n√∫mero mayor a 0. No se permiten valores de 0.'
      });
      document.getElementById('mod_cantidad').focus();
      return;
    }

    // Si pasa las validaciones, proceder con la modificaci√≥n
    modificarProducto();
  }

  // Funci√≥n auxiliar para formatear fechas
  function formatDateForInput(dateString) {
    if (!dateString) return '';
    const [year, month, day] = dateString.split('T')[0].split('-');
    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
  }


  // Funci√≥n para obtener el stock actual de un producto (suma de todos los lotes disponibles)
  async function obtenerStockActual(codigoProducto) {
    try {
      const response = await fetch(`/productos/api/stock-producto/${codigoProducto}`);
      const data = await response.json();

      if (data.success) {
        return data.stock || 0;
      } else {
        console.error('Error al obtener stock:', data.message);
        return 0;
      }
    } catch (error) {
      console.error('Error al obtener stock:', error);
      return 0;
    }
  }

  // Funci√≥n para modificar un producto (agregar nuevo lote)
  async function modificarProducto() {
    const codigoProducto = document.getElementById('select_producto_modificar').value;
    if (!codigoProducto) {
      Swal.fire('Error', 'Debe seleccionar un producto', 'error');
      return;
    }

    const precio_nuevo = parseFloat(document.getElementById('mod_precio_compra').value);
    const cantidad_nueva = parseInt(document.getElementById('mod_cantidad').value);
    const ubicacionValor = document.getElementById('mod_ubicacion').value;
    const fecha_vencimiento_nueva = document.getElementById('mod_fecha_vencimiento').value || null;

    // Validaciones adicionales
    if (isNaN(precio_nuevo) || precio_nuevo <= 0) {
      Swal.fire('Error', 'El precio debe ser un n√∫mero mayor a 0', 'error');
      return;
    }
    if (isNaN(cantidad_nueva) || cantidad_nueva <= 0) {
      Swal.fire('Error', 'La cantidad debe ser un n√∫mero mayor a 0', 'error');
      return;
    }
    if (!ubicacionValor) {
      Swal.fire('Error', 'Debe seleccionar una ubicaci√≥n', 'error');
      return;
    }

    let ubicacionTexto = ubicacionValor;
    if (/^E\d+R\d+E\d+$/.test(ubicacionValor)) {
      const partes = ubicacionValor.match(/E(\d+)R(\d+)E(\d+)/);
      ubicacionTexto = `Estante ${partes[1]}, Repisa ${partes[2]}, Espacio ${partes[3]}`;
    }

    try {
      // Obtener stock actual para mostrar en el mensaje de confirmaci√≥n
      const stockActual = await obtenerStockActual(codigoProducto);

      const stockActualNum = Number(stockActual);
      const cantidadNuevaNum = Number(cantidad_nueva);
      const nuevoTotal = stockActualNum + cantidadNuevaNum;

      const precio_anterior = parseFloat(document.getElementById('mod_precio_compra').dataset.originalValue) || 0;

      const mensajeConfirmacion = `
      ¬øDesea agregar un nuevo lote con los siguientes datos?<br><br>
      <strong>Producto:</strong> ${codigoProducto}<br>
      <strong>Precio anterior:</strong> C$${precio_anterior.toFixed(2)}<br>
      <strong>Precio nuevo:</strong> C$${precio_nuevo.toFixed(2)}<br>
      <strong>Cantidad a agregar:</strong> ${cantidadNuevaNum}<br>
      <strong>Stock actual:</strong> ${stockActualNum}<br>
      <strong>Nuevo total:</strong> ${nuevoTotal}<br>
      <strong>Ubicaci√≥n:</strong> ${ubicacionTexto}<br>
      <strong>Fecha Vencimiento:</strong> ${fecha_vencimiento_nueva || 'N/A'}<br><br>
      <i>Se crear√° un nuevo lote con fecha de entrada actual</i>
    `;

      Swal.fire({
        title: '¬øConfirmar nuevo lote?',
        html: mensajeConfirmacion,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'S√≠, agregar lote',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33'
      }).then(async (result) => {
        if (result.isConfirmed) {
          const btnModificar = document.getElementById('modificarProductoButton');
          btnModificar.disabled = true;
          btnModificar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

          try {
            const response = await fetch(`/productos/api/productos/${codigoProducto}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                precio_compra: precio_nuevo,
                cantidad: cantidadNuevaNum,
                descripcion: ubicacionTexto,
                fecha_vencimiento: fecha_vencimiento_nueva
              })
            });

            const result = await response.json();

            if (result.success) {
              await Swal.fire({
                icon: 'success',
                title: '¬°Lote agregado!',
                html: `
                <strong>Producto:</strong> ${codigoProducto}<br>
                <strong>Cantidad agregada:</strong> ${cantidadNuevaNum}<br>
                <strong>Stock anterior:</strong> ${result.datos.stock_anterior}<br>
                <strong>Nuevo total:</strong> ${result.datos.stock_nuevo}<br>
                <strong>Precio actualizado:</strong> C$${precio_nuevo.toFixed(2)}
              `,
                timer: 3000,
                timerProgressBar: true
              });

              // CORRECCI√ìN: Recargar y reordenar datos
              await recargarYReordenarInventario();
              cargarSelectProductos();
              cargarProductosParaBajas();

              // Limpiar formulario
              document.getElementById('formulario-modificacion').style.display = 'none';
              document.getElementById('select_producto_modificar').value = '';

              // Limpiar campos editables
              document.getElementById('mod_precio_compra').value = '';
              document.getElementById('mod_cantidad').value = '';

              // Ocultar informaci√≥n de inventario
              document.getElementById('mod_inventario_info').style.display = 'none';
              document.getElementById('mod_precio_base_info').style.display = 'none';

            } else {
              throw new Error(result.message || 'No se pudo agregar el lote');
            }
          } catch (error) {
            console.error('Error al agregar lote:', error);
            Swal.fire('Error', error.message || 'Error al conectar con el servidor', 'error');
          } finally {
            const btnModificar = document.getElementById('modificarProductoButton');
            if (btnModificar) {
              btnModificar.disabled = false;
              btnModificar.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Cambios';
            }
          }
        }
      });
    } catch (error) {
      console.error('Error al obtener stock:', error);
      Swal.fire('Error', 'No se pudo obtener el stock actual del producto', 'error');
    }
  }

  // Funci√≥n para limpiar el formulario de producto
  function limpiarFormularioProducto() {
    const form = document.getElementById('form-producto');
    if (form) form.reset();

    const fechaEntrada = document.getElementById('fecha_entrada');
    if (fechaEntrada) fechaEntrada.value = new Date().toISOString().split('T')[0];

    const campos = ['codigo_producto', 'nombre', 'marca', 'precio_compra', 'cantidad'];
    campos.forEach(id => {
      const campo = document.getElementById(id);
      if (campo) campo.readOnly = false;
    });

    const sector = document.getElementById('sector');
    if (sector) {
      sector.disabled = false;
      sector.value = '';
    }

    const codigoProveedor = document.getElementById('codigo_proveedor');
    if (codigoProveedor) {
      codigoProveedor.disabled = true;
      codigoProveedor.innerHTML = '<option value="" disabled selected>Seleccione un proveedor</option>';
    }

    const checkVencimiento = document.getElementById('check_vencimiento');
    if (checkVencimiento) {
      checkVencimiento.checked = false;
      checkVencimiento.disabled = false;
    }

    const fechaVencimiento = document.getElementById('fecha_vencimiento');
    if (fechaVencimiento) {
      fechaVencimiento.value = '';
      fechaVencimiento.disabled = true;
    }

    const ubicacion = document.getElementById('ubicacion');
    if (ubicacion) {
      ubicacion.disabled = false;
      ubicacion.value = '';
    }

    const selectModificar = document.getElementById('select_producto_modificar');
    if (selectModificar) {
      selectModificar.value = '';
    }

    const modificarBtn = document.getElementById('modificarProductoButton');
    if (modificarBtn) {
      modificarBtn.disabled = true;
      modificarBtn.style.display = 'none';
    }

    const agregarBtn = document.getElementById('agregarProducto');
    if (agregarBtn) {
      agregarBtn.style.display = 'block';
    }

    const guardarBtn = document.getElementById('guardarProductos');
    if (guardarBtn) {
      guardarBtn.style.display = 'block';
    }
  }

  // Funci√≥n para agregar producto a la lista temporal
  function agregarProductoTemporal() {
    const form = document.getElementById('form-producto');
    const codigoProducto = form.codigo_producto.value;
    const nombre = form.nombre.value;
    const marca = form.marca.value;
    const ubicacionValor = form.ubicacion.value;
    let ubicacionTexto = ubicacionValor;

    if (/^E\d+R\d+E\d+$/.test(ubicacionValor)) {
      const partes = ubicacionValor.match(/E(\d+)R(\d+)E(\d+)/);
      ubicacionTexto = `Estante ${partes[1]}, Repisa ${partes[2]}, Espacio ${partes[3]}`;
    } else {
      const regex = /^Estante\s\d{1,2},\sRepisa\s\d{1,2},\sEspacio\s\d{1,2}$/;
      if (!regex.test(ubicacionTexto)) {
        Swal.fire('Error', 'El formato de ubicaci√≥n no es v√°lido', 'error');
        return;
      }
    }

    const fechaVencimiento = document.getElementById('check_vencimiento').checked ? form.fecha_vencimiento.value : null;
    const sector = form.sector.value;
    const codigoProveedor = form.codigo_proveedor.value;
    const precioCompra = parseFloat(form.precio_compra.value);
    const cantidad = parseInt(form.cantidad.value);
    const fechaEntrada = form.fecha_entrada.value;

    // Validaci√≥n de campos obligatorios
    if (!codigoProducto || !nombre || !marca || !ubicacionValor || !sector || !codigoProveedor || isNaN(precioCompra) || isNaN(cantidad)) {
      Swal.fire({
        icon: 'warning',
        title: 'Campos incompletos',
        text: 'Por favor, complete todos los campos obligatorios antes de agregar.'
      });
      return;
    }

    // Crear objeto producto
    const producto = {
      codigo_producto: codigoProducto,
      nombre: nombre,
      marca: marca,
      descripcion: ubicacionTexto,
      ubicacion: ubicacionValor,
      fecha_vencimiento: fechaVencimiento,
      sector: sector,
      codigo_proveedor: codigoProveedor,
      precio_compra: precioCompra,
      cantidad: cantidad,
      fecha_entrada: fechaEntrada
    };

    // Agregar imagen si existe (USANDO LAS MISMAS VARIABLES GLOBALES)
    if (imagenActual) {
      producto.imagen_base64 = imagenActual;
      producto.imagen_nombre = imagenNombre;
      producto.imagen_tipo = imagenTipo;

      console.log('Imagen agregada al producto temporal:', {
        codigo: codigoProducto,
        tieneImagen: true,
        longitudBase64: imagenActual.length,
        tipo: imagenTipo
      });
    } else {
      console.log('Producto sin imagen:', codigoProducto);
    }

    // Agregar a la lista temporal
    productosTemp.push(producto);

    // Actualizar tabla temporal
    actualizarTablaTemporal();

    // Limpiar formulario (PERO MANTENER LA IMAGEN SI SE QUIERE REUTILIZAR)
    limpiarCamposFormulario();

    // Mostrar confirmaci√≥n
    Swal.fire({
      icon: 'success',
      title: 'Producto agregado',
      text: 'El producto ha sido a√±adido a la lista temporal',
      timer: 2000,
      showConfirmButton: false
    });
  }


  // Funci√≥n auxiliar para limpiar campos del formulario (MODIFICADA)
  function limpiarCamposFormulario() {
    const form = document.getElementById('form-producto');
    form.codigo_producto.value = '';
    form.nombre.value = '';
    form.marca.value = '';
    form.precio_compra.value = '';
    form.cantidad.value = '';
    document.getElementById('check_vencimiento').checked = false;
    document.getElementById('fecha_vencimiento').value = '';
    document.getElementById('fecha_vencimiento').disabled = true;

    // Limpiar imagen
    removeImage();
  }

  // Funci√≥n para limpiar imagen manualmente
  function limpiarImagenRegistro() {
    imagenActual = null;
    imagenNombre = null;
    imagenTipo = null;

    document.getElementById('preview-container').style.display = 'none';
    document.getElementById('dropZone').style.display = 'block';
    document.getElementById('imagen_producto').value = '';
    document.getElementById('file-info').textContent = '';

    Swal.fire({
      icon: 'success',
      title: 'Imagen limpiada',
      text: 'Puede seleccionar una nueva imagen',
      timer: 1500,
      showConfirmButton: false
    });
  }

  // Funci√≥n para mostrar vista previa de imagen
  document.getElementById('imagen_producto').addEventListener('change', function (e) {
    const file = e.target.files[0];
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');

    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        previewImage.src = e.target.result;
        previewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      previewContainer.style.display = 'none';
    }
  });

  // Funci√≥n para actualizar la tabla temporal
  function actualizarTablaTemporal() {
    const tbody = document.getElementById('tablaProductosTemp');
    tbody.innerHTML = '';

    productosTemp.forEach((producto, index) => {
      const tr = document.createElement('tr');

      let fechaVencimiento = "N/A";
      if (producto.fecha_vencimiento) {
        const fecha = new Date(producto.fecha_vencimiento);
        fechaVencimiento = `${fecha.getDate().toString().padStart(2, '0')}/${(fecha.getMonth() + 1).toString().padStart(2, '0')}/${fecha.getFullYear().toString().slice(-2)}`;
      }

      // Columna para imagen
      const imagenCol = producto.imagen_base64
        ? `<td class="text-center">
           <img src="${producto.imagen_base64}" alt="Imagen" 
                class="table-image" data-bs-toggle="tooltip" 
                title="${producto.imagen_nombre}">
         </td>`
        : '<td class="text-center text-muted">Sin imagen</td>';

      tr.innerHTML = `
      <td>${producto.codigo_producto}</td>
      <td>${producto.nombre}</td>
      <td>${producto.sector}</td>
      <td>${producto.marca}</td>
      <td>${producto.cantidad}</td>
      <td>${producto.precio_compra.toFixed(2)}</td>
      <td>${fechaVencimiento}</td>
      <td>${producto.ubicacion || 'N/A'}</td>
      ${imagenCol}
      <td>
        <button class="btn btn-danger btn-sm eliminar-producto" data-index="${index}">
          <i class="fas fa-trash me-1"></i>Eliminar
        </button>
      </td>
    `;

      tbody.appendChild(tr);
    });

    // Inicializar tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Agregar eventos a los botones de eliminar
    document.querySelectorAll('.eliminar-producto').forEach(button => {
      button.addEventListener('click', function () {
        const index = parseInt(this.getAttribute('data-index'));
        eliminarProductoTemporal(index);
      });
    });
  }


  // Funci√≥n para eliminar producto de la lista temporal
  function eliminarProductoTemporal(index) {
    Swal.fire({
      title: '¬øEst√° seguro?',
      text: "Este producto ser√° eliminado de la lista temporal.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'S√≠, eliminar'
    }).then((result) => {
      if (result.isConfirmed) {
        productosTemp.splice(index, 1);
        actualizarTablaTemporal();
        Swal.fire({
          icon: 'success',
          title: 'Eliminado',
          text: 'El producto ha sido eliminado de la lista temporal.'
        });
      }
    });
  }

  // Funci√≥n para guardar productos temporales
  async function guardarProductos() {
    if (productosTemp.length === 0) {
      Swal.fire({
        icon: 'warning',
        title: 'Lista vac√≠a',
        text: 'No hay productos para guardar.'
      });
      return;
    }

    Swal.fire({
      title: "¬øConfirmar registro?",
      text: `¬øEst√° seguro que desea registrar ${productosTemp.length} producto(s)?`,
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "S√≠, registrar",
      cancelButtonText: "Cancelar"
    }).then(async (result) => {
      if (result.isConfirmed) {
        try {
          const btnGuardar = document.getElementById('guardarProductos');
          btnGuardar.disabled = true;
          btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';

          const response = await fetch('/productos/api/productos', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              productos: productosTemp
            })
          });

          const data = await response.json();

          if (data.success) {
            await Swal.fire({
              icon: "success",
              title: "Productos registrados",
              text: `Se han registrado ${productosTemp.length} producto(s) exitosamente.`,
              showConfirmButton: true
            }).then(() => {
              // Limpiar todo despu√©s de guardar
              productosTemp = [];
              document.getElementById('tablaProductosTemp').innerHTML = '';
              document.getElementById('form-producto').reset();
              document.getElementById('fecha_entrada').value = new Date().toISOString().split('T')[0];

              // Recargar datos
              cargarProductos();
              cargarSelectProductos();
              cargarProductosParaBajas();
            });
          } else {
            throw new Error(data.message || "No se pudieron registrar los productos.");
          }
        } catch (error) {
          console.error("Error al guardar productos:", error);
          Swal.fire("Error", error.message || "Hubo un problema al registrar los productos.", "error");
        } finally {
          const btnGuardar = document.getElementById('guardarProductos');
          if (btnGuardar) {
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Productos';
          }
        }
      }
    });
  }

  // Funci√≥n para registrar una baja de producto
  async function registrarBaja(e) {
    e.preventDefault();

    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';

    try {
      const codigoProducto = $('#product_id').val();
      const quantity = parseInt($('#quantity').val());
      const reason = $('#reason').val();
      const notes = $('#notes').val();

      // Validaciones
      if (!codigoProducto) throw new Error('Debe seleccionar un producto');
      if (isNaN(quantity) || quantity <= 0) throw new Error('La cantidad debe ser un n√∫mero mayor a cero');
      if (reason === 'Otro' && !notes.trim()) throw new Error('Debe especificar el motivo');

      const response = await fetch('/productos/api/productos/baja', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          codigo_producto: codigoProducto,
          motivo: reason,
          cantidad: quantity,
          observaciones: notes
        })
      });

      const result = await response.json();

      if (!result.success) {
        throw new Error(result.message);
      }

      await Swal.fire({
        icon: 'success',
        title: 'Baja registrada',
        text: result.message,
        timer: 3000,
        timerProgressBar: true
      });

      // Resetear el formulario
      form.reset();
      $('#product_id').val('').trigger('change');
      $('#stock-display').text('0');
      $('#notes').val('').prop('disabled', true);

      // Recargar datos
      cargarProductos();
      cargarSelectProductos();
      cargarProductosParaBajas();

    } catch (error) {
      await Swal.fire({
        icon: 'error',
        title: 'Error',
        text: error.message
      });
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-save me-2"></i> Registrar Baja';
    }
  }

  // Variables globales para im√°genes (compartidas para registro y modificaci√≥n)
  let imagenActual = null;
  let imagenNombre = null;
  let imagenTipo = null;

  // Funci√≥n para procesar archivo seleccionado (UNIFICADA)
  async function processFile(file) {
    // Validar tipo de archivo
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!validTypes.includes(file.type)) {
      Swal.fire({
        icon: 'error',
        title: 'Formato no v√°lido',
        text: 'Solo se permiten im√°genes JPG, PNG, GIF o WebP'
      });
      return;
    }

    // Validar tama√±o m√°ximo (5MB)
    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
      Swal.fire({
        icon: 'error',
        title: 'Archivo muy grande',
        html: `La imagen es demasiado grande (${(file.size / 1024 / 1024).toFixed(2)} MB).<br>
             El tama√±o m√°ximo permitido es 5 MB.`
      });
      return;
    }

    try {
      const btnActualizar = document.getElementById('actualizarImagenButton');
      if (btnActualizar) {
        btnActualizar.disabled = true;
      }

      // Mostrar loading
      Swal.fire({
        title: 'Procesando imagen...',
        text: 'Comprimiendo y optimizando imagen',
        icon: 'info',
        showConfirmButton: false,
        allowOutsideClick: false
      });

      // Comprimir imagen (siempre comprimir, no solo cuando es grande)
      const compressed = await compressImage(file, 800, 0.6); // M√°s compresi√≥n

      Swal.close();

      console.log(`üì∏ Imagen comprimida: ${(file.size / 1024 / 1024).toFixed(2)}MB ‚Üí ${(compressed.size / 1024 / 1024).toFixed(2)}MB (${compressed.compression}% reducci√≥n)`);

      imagenActual = compressed.base64;
      imagenNombre = file.name.replace(/\.[^/.]+$/, ".webp"); // Cambiar extensi√≥n a webp
      imagenTipo = 'image/webp';

      // Mostrar informaci√≥n del archivo
      const originalSize = (file.size / 1024 / 1024).toFixed(2);
      const compressedSize = (compressed.size / 1024 / 1024).toFixed(2);
      document.getElementById('file-info').textContent =
        `${file.name} ‚Ä¢ ${originalSize}MB ‚Üí ${compressedSize}MB ‚Ä¢ WebP (${compressed.compression}% menor)`;

      // Mostrar vista previa
      document.getElementById('preview-image').src = imagenActual;
      document.getElementById('preview-container').style.display = 'block';
      document.getElementById('dropZone').style.display = 'none';

      if (btnActualizar) {
        btnActualizar.disabled = false;
      }

    } catch (error) {
      console.error('Error procesando imagen:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'No se pudo procesar la imagen. Intente con otra imagen.'
      });
    }
  }

  // Funci√≥n de compresi√≥n mejorada
  function compressImage(file, maxWidth = 800, quality = 0.6) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();

      reader.onload = function (e) {
        img.src = e.target.result;
      };

      img.onload = function () {
        const canvas = document.createElement('canvas');
        let { width, height } = img;

        // Calcular nuevas dimensiones manteniendo aspect ratio
        if (width > maxWidth) {
          height = Math.round((height * maxWidth) / width);
          width = maxWidth;
        }

        canvas.width = width;
        canvas.height = height;

        const ctx = canvas.getContext('2d');

        // Mejorar la calidad de renderizado
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, 0, 0, width, height);

        // Convertir a WebP con calidad ajustable
        canvas.toBlob(
          blob => {
            if (!blob) {
              reject(new Error('No se pudo comprimir la imagen'));
              return;
            }

            const newReader = new FileReader();
            newReader.onload = function (e) {
              resolve({
                base64: e.target.result,
                size: blob.size,
                originalSize: file.size,
                compression: Math.max(0, ((1 - (blob.size / file.size)) * 100).toFixed(1))
              });
            };
            newReader.readAsDataURL(blob);
          },
          'image/webp',
          quality
        );
      };

      img.onerror = () => reject(new Error('Error al cargar la imagen'));
      reader.onerror = () => reject(new Error('Error al leer el archivo'));

      reader.readAsDataURL(file);
    });
  }

  // Funci√≥n para tomar foto desde la c√°mara (REGISTRO)
  function takePhoto() {
    const input = document.getElementById('imagen_producto');

    // En dispositivos m√≥viles, esto activar√° la c√°mara
    // En desktop, permitir√° seleccionar archivo
    input.setAttribute('capture', 'camera');
    input.click();

    // Restaurar atributo despu√©s de usar
    setTimeout(() => {
      input.removeAttribute('capture');
    }, 1000);
  }

  // Funci√≥n para eliminar imagen (REGISTRO)
  function removeImage() {
    imagenActual = null;
    imagenNombre = null;
    imagenTipo = null;

    document.getElementById('preview-container').style.display = 'none';
    document.getElementById('dropZone').style.display = 'block';
    document.getElementById('imagen_producto').value = '';
    document.getElementById('file-info').textContent = '';
  }

  // Event Listeners para el √°rea de arrastrar y soltar (REGISTRO)
  document.addEventListener('DOMContentLoaded', function () {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('imagen_producto');

    // Click en el √°rea de drop
    dropZone.addEventListener('click', function (e) {
      if (e.target.tagName !== 'BUTTON') {
        fileInput.click();
      }
    });

    // Cambio en el input file
    fileInput.addEventListener('change', function (e) {
      if (this.files && this.files[0]) {
        processFile(this.files[0]);
      }
    });

    // Arrastrar y soltar
    dropZone.addEventListener('dragover', function (e) {
      e.preventDefault();
      this.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', function (e) {
      e.preventDefault();
      this.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', function (e) {
      e.preventDefault();
      this.classList.remove('dragover');

      if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        processFile(e.dataTransfer.files[0]);
      }
    });

    // Soporte para touch en m√≥viles
    dropZone.addEventListener('touchstart', function (e) {
      this.classList.add('dragover');
    });

    dropZone.addEventListener('touchend', function (e) {
      this.classList.remove('dragover');
    });
  });


  // Funci√≥n debug para verificar datos antes de enviar
  function debugProductosTemp() {
    console.log('=== DEBUG Productos Temporales ===');
    productosTemp.forEach((producto, index) => {
      console.log(`Producto ${index}:`, {
        codigo: producto.codigo_producto,
        nombre: producto.nombre,
        tieneImagen: !!producto.imagen_base64,
        longitudImagen: producto.imagen_base64 ? producto.imagen_base64.length : 0,
        tipoImagen: producto.imagen_tipo,
        nombreImagen: producto.imagen_nombre,
        // Mostrar primeros 100 caracteres del base64 para verificar
        base64Preview: producto.imagen_base64 ? producto.imagen_base64.substring(0, 100) + '...' : 'No hay imagen'
      });
    });
    console.log('Total productos:', productosTemp.length);
    console.log('Productos con imagen:', productosTemp.filter(p => p.imagen_base64).length);
    console.log('================================');
  }

  // Modificar la funci√≥n guardarProductos para incluir debug
  async function guardarProductos() {
    if (productosTemp.length === 0) {
      Swal.fire({
        icon: 'warning',
        title: 'Lista vac√≠a',
        text: 'No hay productos para guardar.'
      });
      return;
    }

    // Debug antes de enviar
    debugProductosTemp();

    Swal.fire({
      title: "¬øConfirmar registro?",
      html: `¬øEst√° seguro que desea registrar <strong>${productosTemp.length}</strong> producto(s)?<br>
               <small>Productos con imagen: ${productosTemp.filter(p => p.imagen_base64).length}</small>`,
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "S√≠, registrar",
      cancelButtonText: "Cancelar"
    }).then(async (result) => {
      if (result.isConfirmed) {
        try {
          const btnGuardar = document.getElementById('guardarProductos');
          btnGuardar.disabled = true;
          btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';

          console.log('Enviando datos al servidor...');

          const response = await fetch('/productos/api/productos', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              productos: productosTemp
            })
          });

          const data = await response.json();
          console.log('Respuesta del servidor:', data);

          if (data.success) {
            await Swal.fire({
              icon: "success",
              title: "Productos registrados",
              html: `Se han registrado <strong>${productosTemp.length}</strong> producto(s) exitosamente.<br>
                               <small>Productos con imagen: ${data.productos_con_imagen || 0}</small>`,
              showConfirmButton: true
            }).then(() => {
              // Limpiar todo despu√©s de guardar
              productosTemp = [];
              document.getElementById('tablaProductosTemp').innerHTML = '';
              document.getElementById('form-producto').reset();
              document.getElementById('fecha_entrada').value = new Date().toISOString().split('T')[0];
              removeImage();

              // Recargar datos
              cargarProductos();
              cargarSelectProductos();
              cargarProductosParaBajas();
            });
          } else {
            throw new Error(data.message || "No se pudieron registrar los productos.");
          }
        } catch (error) {
          console.error("Error al guardar productos:", error);
          Swal.fire("Error", error.message || "Hubo un problema al registrar los productos.", "error");
        } finally {
          const btnGuardar = document.getElementById('guardarProductos');
          if (btnGuardar) {
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Productos';
          }
        }
      }
    });
  }

  // Funci√≥n mejorada para manejar errores de carga de im√°genes
  function manejarErrorImagen(imgElement, codigoProducto) {
    console.log(`üîÑ Recargando imagen fallida para producto ${codigoProducto}`);

    // Intentar recargar con nuevo timestamp
    const newTimestamp = new Date().getTime();
    const baseUrl = imgElement.src.split('?')[0];
    const newUrl = `${baseUrl}?t=${newTimestamp}&retry=1`;

    imgElement.src = newUrl;
    imgElement.onerror = function () {
      // Si sigue fallando, mostrar placeholder y intentar obtener de la API
      this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIGZpbGw9IiNGNUY1RjUiLz48cGF0aCBkPSJNMzAgMzdDMzIuNzYxNCAzNyAzNSAzNC43NjE0IDM1IDMyQzM1IDI5LjIzODYgMzIuNzYxNCAyNyAzMCAyN0MyNy4yMzg2IDI3IDI1IDI5LjIzODYgMjUgMzJDMjUgMzQuNzYxNCAyNy4yMzg2IDM3IDMwIDM3WiIgZmlsbD0iI0NEQ0RDRCIvPjxwYXRoIGQ9Ik0zNi41IDIyLjVIMjMuNUMxOS4zNTc5IDIyLjUgMTYgMjUuODU3OSAxNiAzMFY0MUMxNiA0NS4xNDIxIDE5LjM1NzkgNDguNSAyMy41IDQ4LjVIMzYuNUM0MC42NDIxIDQ4LjUgNDQgNDUuMTNDMjEgNDQgNDEgMjUuODU3OSA0MSAyMS43NVYzMEM0MSAyNS44NTc5IDQwLjY0MjEgMjIuNSAzNi41IDIyLjVaIiBmaWxsPSIjQ0RDRENEIi8+PC9zdmc+';
      this.alt = 'Imagen no disponible';
      this.style.cursor = 'default';
      this.onclick = null;

      // Intentar recuperar la imagen desde la API
      recuperarImagenDesdeAPI(codigoProducto);
    };
  }

  // Funci√≥n para recuperar imagen desde API
  async function recuperarImagenDesdeAPI(codigoProducto) {
    try {
      const response = await fetch(`/productos/api/productos/${codigoProducto}/imagen`);
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.imagen_url) {
          // Actualizar todas las instancias de esta imagen en la p√°gina
          const imagenes = document.querySelectorAll(`img[data-producto="${codigoProducto}"]`);
          imagenes.forEach(img => {
            img.src = data.imagen_url;
            img.onclick = function () { ampliarImagen(data.imagen_url); };
            img.style.cursor = 'pointer';
          });
          console.log(`‚úÖ Imagen recuperada para producto ${codigoProducto}`);
        }
      }
    } catch (error) {
      console.error(`‚ùå Error recuperando imagen para ${codigoProducto}:`, error);
    }
  }

  // Funci√≥n para forzar recarga de im√°genes espec√≠ficas
  async function recargarImagenProducto(codigoProducto) {
    try {
      const response = await fetch(`/productos/api/productos/${codigoProducto}/imagen`);
      const data = await response.json();

      if (data.success && data.imagen_url) {
        // Actualizar todas las instancias de esta imagen en la p√°gina
        const imagenes = document.querySelectorAll(`img[data-producto="${codigoProducto}"]`);
        imagenes.forEach(img => {
          img.src = data.imagen_url;
        });
        console.log(`‚úÖ Imagen recargada para producto ${codigoProducto}`);
      }
    } catch (error) {
      console.error(`‚ùå Error recargando imagen para ${codigoProducto}:`, error);
    }
  }

  // Comando de diagn√≥stico para im√°genes
  window.diagnosticoImagenes = async function (codigoProducto = null) {
    try {
      let url = '/productos/api/productos/diagnostico-imagenes';
      if (codigoProducto) {
        url += `?producto=${codigoProducto}`;
      }

      const response = await fetch(url);
      const data = await response.json();
      console.log('üîç Diagn√≥stico de im√°genes:', data);
      return data;
    } catch (error) {
      console.error('Error en diagn√≥stico:', error);
    }
  };

  // ‚úÖ FUNCI√ìN FALTANTE: Procesar nueva imagen en modificaci√≥n
  function procesarNuevaImagenModificar(file) {
    if (!file) return;

    // Validar tipo de archivo
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!validTypes.includes(file.type)) {
      Swal.fire({
        icon: 'error',
        title: 'Formato no v√°lido',
        text: 'Solo se permiten im√°genes JPG, PNG, GIF o WebP'
      });
      return;
    }

    // Validar tama√±o (2MB m√°ximo)
    if (file.size > 2 * 1024 * 1024) {
      Swal.fire({
        icon: 'error',
        title: 'Archivo muy grande',
        text: 'La imagen no debe superar los 2MB'
      });
      return;
    }

    // Crear FileReader para mostrar vista previa
    const reader = new FileReader();
    reader.onload = function (e) {
      imagenActualModificar = e.target.result; // Base64
      imagenNombreModificar = file.name;
      imagenTipoModificar = file.type;

      // Mostrar vista previa
      document.getElementById('mod_preview_image').src = e.target.result;
      document.getElementById('mod_preview_nueva_imagen').style.display = 'block';

      // Mostrar bot√≥n de actualizar imagen
      document.getElementById('actualizarImagenButton').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }

  // WebSocket Manager PARA SUPABASE - Versi√≥n Corregida
  class WebSocketManager {
    constructor() {
      this.socket = null;
      this.isConnected = false;
      this.connectionId = null;
      this.reconnectAttempts = 0;
      this.maxReconnectAttempts = 10;
    }

    initialize() {
      try {
        console.log('üîÑ Iniciando WebSocket Manager...');

        // Verificar que Socket.io est√© cargado
        if (typeof io === 'undefined') {
          console.error('‚ùå Socket.io no est√° cargado');
          this.mostrarErrorSocketIO();
          return;
        }

        console.log('‚úÖ Socket.io disponible, conectando...');

        // Configuraci√≥n simple
        this.socket = io({
          transports: ['websocket', 'polling'],
          timeout: 10000,
          reconnectionAttempts: this.maxReconnectAttempts,
          reconnectionDelay: 2000
        });

        this.setupEventHandlers();

      } catch (error) {
        console.error('‚ùå Error inicializando WebSocket:', error);
      }
    }

    setupEventHandlers() {
      // CONEXI√ìN EXITOSA
      this.socket.on('connect', () => {
        console.log('='.repeat(50));
        console.log('‚úÖ WEBSOCKET CONECTADO');
        console.log('   ID:', this.socket.id);
        console.log('   URL:', window.location.origin);
        console.log('='.repeat(50));

        this.isConnected = true;
        this.connectionId = this.socket.id;
        this.reconnectAttempts = 0;

        this.showNotification('‚úÖ Conexi√≥n en tiempo real activa', 'success', 3000);

        // Registrar en servidor
        this.socket.emit('cliente_conectado', {
          tipo: 'gestion_productos',
          pagina: 'productos',
          timestamp: new Date().toISOString()
        });
      });

      // EVENTOS DE PRODUCTOS
      this.socket.on('productos_actualizados', (data) => {
        console.log('üì¶ Productos actualizados:', data);
        this.showNotification(`üì¶ ${data.total_productos} producto(s) actualizado(s)`, 'info', 4000);
        this.recargarInventarioForzado();
      });

      this.socket.on('imagen_actualizada', (data) => {
        console.log('üñºÔ∏è Imagen actualizada:', data);
        this.showNotification(`üñºÔ∏è Imagen de ${data.codigo_producto} actualizada`, 'success', 4000);
        this.actualizarImagenInmediata(data.codigo_producto, data.imagen_url);
      });

      // MENSAJES DEL SERVIDOR
      this.socket.on('server_hello', (data) => {
        console.log('üëã Servidor:', data.message);
      });

      // MANEJO DE ERRORES
      this.socket.on('disconnect', (reason) => {
        console.log('üîå Desconectado:', reason);
        this.isConnected = false;
        this.showNotification('üîå Conexi√≥n perdida', 'warning', 3000);
      });

      this.socket.on('connect_error', (error) => {
        this.reconnectAttempts++;
        console.error('‚ùå Error conexi√≥n:', error.message);
      });
    }

    // RECARGAR INVENTARIO
    async recargarInventarioForzado() {
      try {
        console.log('üîÑ Recargando inventario...');
        if ($.fn.DataTable.isDataTable('#productosTable')) {
          productosTable.destroy();
        }
        await cargarProductos(new Date().getTime());
      } catch (error) {
        console.error('‚ùå Error recargando inventario:', error);
      }
    }

    // ACTUALIZAR IMAGEN
    actualizarImagenInmediata(codigoProducto, imagenUrl) {
      if (!imagenUrl) return;

      const nuevaUrl = `${imagenUrl}?t=${new Date().getTime()}`;

      // Actualizar en tabla
      const imagenes = document.querySelectorAll(`img[data-producto="${codigoProducto}"]`);
      imagenes.forEach(img => {
        img.src = nuevaUrl;
      });

      // Actualizar en formulario si est√° abierto
      const productoActual = document.getElementById('select_producto_modificar')?.value;
      if (productoActual === codigoProducto) {
        const imgFormulario = document.getElementById('mod_imagen_actual');
        if (imgFormulario) {
          imgFormulario.src = nuevaUrl;
        }
      }
    }

    // NOTIFICACIONES
    showNotification(message, type = 'info', timer = 3000) {
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: type,
          title: message,
          showConfirmButton: false,
          timer: timer,
          timerProgressBar: true
        });
      }
    }

    // DIAGN√ìSTICO
    testConexion() {
      if (this.isConnected) {
        this.socket.emit('test_conexion', {
          mensaje: 'Test desde cliente',
          timestamp: new Date().toISOString()
        });
        this.showNotification('üß™ Test enviado', 'info', 2000);
      }
    }

    obtenerEstado() {
      return {
        conectado: this.isConnected,
        id: this.connectionId,
        reintentos: this.reconnectAttempts
      };
    }

    mostrarErrorSocketIO() {
      console.error('‚ùå Socket.io no cargado. Verifica el script en el HTML.');
    }
  }

  // ========== INICIALIZACI√ìN CORREGIDA ==========

  // Funci√≥n de inicializaci√≥n segura
  function inicializarWebSockets() {
    console.log('üöÄ INICIANDO WEBSOCKETS...');

    // Crear instancia global √öNICA
    window.wsManager = new WebSocketManager();

    // Inicializar despu√©s de un delay
    setTimeout(() => {
      try {
        window.wsManager.initialize();
      } catch (error) {
        console.error('‚ùå Error en inicializaci√≥n:', error);
      }
    }, 1000);
  }

  // ========== FUNCIONES DE DIAGN√ìSTICO ==========

  window.diagnosticoWebSockets = function () {
    console.log('='.repeat(50));
    console.log('üîç DIAGN√ìSTICO WEBSOCKETS');
    console.log('='.repeat(50));
    console.log('üìç URL:', window.location.origin);
    console.log('üì° Socket.io:', typeof io !== 'undefined' ? '‚úÖ CARGADO' : '‚ùå FALTANTE');
    console.log('üë®‚Äçüíº WebSocket Manager:', window.wsManager ? '‚úÖ INICIALIZADO' : '‚ùå NO INICIALIZADO');

    if (window.wsManager) {
      const estado = window.wsManager.obtenerEstado();
      console.log('üîó Conectado:', estado.conectado ? '‚úÖ SI' : '‚ùå NO');
      console.log('üÜî ID:', estado.id || 'N/A');
      console.log('üîÑ Reintentos:', estado.reintentos);
    }

    console.log('='.repeat(50));
  };

  window.probarConexion = function () {
    if (window.wsManager) {
      window.wsManager.testConexion();
    } else {
      console.error('‚ùå WebSocket Manager no disponible');
    }
  };

  // ========== INICIALIZACI√ìN AL CARGAR LA P√ÅGINA ==========

  // Tu c√≥digo existente de inicializaci√≥n - MODIFICADO
  document.addEventListener("DOMContentLoaded", function () {
    console.log('üìÑ DOM cargado - Iniciando aplicaci√≥n...');

    // Configurar fecha de entrada
    document.getElementById('fecha_entrada').value = fechaActual;

    // INICIALIZAR WEBSOCKETS PRIMERO
    inicializarWebSockets();

    // Event listeners existentes
    document.getElementById('sector').addEventListener('change', cargarProveedores);
    document.getElementById('check_vencimiento').addEventListener('change', toggleFechaVencimiento);
    document.getElementById('agregarProducto').addEventListener('click', agregarProductoTemporal);
    document.getElementById('guardarProductos').addEventListener('click', guardarProductos);

    // Configurar Select2
    $('.select2-search').select2({
      language: "es",
      placeholder: "Escriba para buscar productos...",
      allowClear: true,
      width: '100%',
      minimumInputLength: 1,
      dropdownParent: $('#modify')
    });

    // Manejar cambio en motivo de baja
    document.getElementById('reason').addEventListener('change', function () {
      const notesTextarea = document.getElementById('notes');
      if (this.value === 'Otro') {
        notesTextarea.disabled = false;
        notesTextarea.required = true;
      } else {
        notesTextarea.disabled = true;
        notesTextarea.required = false;
        notesTextarea.value = '';
      }
    });

    // Manejar cambio en select de productos para bajas
    $('#product_id').on('change', function () {
      const selectedOption = $(this).find('option:selected');
      const stock = selectedOption.data('stock') || 0;
      $('#stock-display').text(stock);
      $('#quantity').attr('max', stock);
    });

    // Manejar env√≠o del formulario de bajas
    document.getElementById('bajaForm').addEventListener('submit', registrarBaja);

    // Cargar datos iniciales
    cargarProductos();
    cargarSelectProductos();
    cargarProductosParaBajas();
    generarOpcionesUbicacion();

    // Diagn√≥stico autom√°tico despu√©s de 3 segundos
    setTimeout(() => {
      diagnosticoWebSockets();
    }, 3000);
  });

  // Comandos de diagn√≥stico para la consola
  window.diagnosticoSistema = function () {
    console.log('='.repeat(60));
    console.log('üîç DIAGN√ìSTICO COMPLETO DEL SISTEMA');
    console.log('='.repeat(60));
    console.log('üåê WebSocket:', window.wsManager?.isConnected ? '‚úÖ CONECTADO' : '‚ùå DESCONECTADO');
    console.log('üÜî ID:', window.wsManager?.connectionId);
    console.log('üóÑÔ∏è  Base de datos:', 'Supabase');
    console.log('üìç URL:', window.location.origin);
    console.log('‚è∞ Hora:', new Date().toLocaleTimeString());
    console.log('='.repeat(60));
  };

  // Probar sincronizaci√≥n manual
  window.probarSincronizacion = function () {
    if (window.wsManager && window.wsManager.isConnected) {
      // Emitir evento de prueba
      window.wsManager.socket.emit('test_sincronizacion', {
        mensaje: 'Prueba de sincronizaci√≥n',
        timestamp: new Date().toISOString(),
        producto: 'TEST-001'
      });

      console.log('üß™ Evento de prueba enviado');
      Swal.fire('Prueba', 'Evento de sincronizaci√≥n enviado', 'info');
    } else {
      console.error('‚ùå WebSocket no conectado');
      Swal.fire('Error', 'WebSocket no conectado', 'error');
    }
  };

  // Verificar estado de WebSocket
  window.estadoWebSocket = function () {
    if (window.wsManager) {
      const estado = window.wsManager.obtenerEstado();
      console.log('üìä Estado WebSocket:', estado);
      return estado;
    }
    return null;
  };
</script>