<link rel="stylesheet" href="/styles/reportes.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">


<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg p-4">
                <div class="card-body">
                    <!-- Formulario para generar reportes -->
                    <div class="card-header bg-info text-white">
                        <h2 class="h5 mb-0">Generar Reportes</h2>
                    </div>

                </div>

                <!-- Sección de Reportes -->
                <div class="row">
                    <!-- Reporte de Ventas -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h2 class="h5 mb-0">Reporte de Ventas</h2>
                            </div>
                            <div class="card-body">
                                <div class="list-group list-group-flush">
                                    <div class="list-group-item d-flex align-items-center">
                                        <div class="form-check me-3">
                                            <input class="form-check-input" type="checkbox" id="diario">
                                            <label class="form-check-label" for="diario">Diario</label>
                                        </div>
                                        <span class="badge bg-secondary ms-auto">Últimos 7 días</span>
                                    </div>
                                    <div class="list-group-item d-flex align-items-center">
                                        <div class="form-check me-3">
                                            <input class="form-check-input" type="checkbox" id="semanal">
                                            <label class="form-check-label" for="semanal">Semanal</label>
                                        </div>
                                        <span class="badge bg-secondary ms-auto">Últimas 4 semanas</span>
                                    </div>
                                    <div class="list-group-item d-flex align-items-center">
                                        <div class="form-check me-3">
                                            <input class="form-check-input" type="checkbox" id="mensual">
                                            <label class="form-check-label" for="mensual">Mensual</label>
                                        </div>
                                        <span class="badge bg-secondary ms-auto">Últimos 12 meses</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <button class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download me-1"></i>Exportar selección
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Reporte de Productos -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h2 class="h5 mb-0">Reporte de Productos</h2>
                            </div>
                            <div class="card-body">
                                <div class="list-group list-group-flush">
                                    <div class="list-group-item d-flex align-items-center">
                                        <span class="badge bg-success me-3">+</span>
                                        <span>Producto + vendido</span>
                                        <span class="badge bg-primary ms-auto">Top 5</span>
                                    </div>
                                    <div class="list-group-item d-flex align-items-center">
                                        <span class="badge bg-danger me-3">-</span>
                                        <span>Producto - vendido</span>
                                        <span class="badge bg-primary ms-auto">Peores 5</span>
                                    </div>
                                    <div class="list-group-item d-flex align-items-center">
                                        <span class="badge bg-warning me-3">○</span>
                                        <span>Producto no vendido</span>
                                        <span class="badge bg-primary ms-auto">Sin ventas</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <button id="exportarProductos" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-file-earmark-excel"></i> Exportar reporte
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script src="reportes.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>



<script>

    document.querySelector('.btn-outline-primary').addEventListener('click', async () => {
        let filtro = null;
        const checkboxes = {
            diario: document.getElementById('diario'),
            semanal: document.getElementById('semanal'),
            mensual: document.getElementById('mensual')
        };

        // Verificar qué checkbox está seleccionado
        for (const [key, checkbox] of Object.entries(checkboxes)) {
            if (checkbox.checked) {
                filtro = key;
                break;
            }
        }

        if (!filtro) {
            await Swal.fire({
                icon: 'warning',
                title: 'Filtro requerido',
                text: 'Por favor selecciona un filtro primero',
                confirmButtonText: 'Entendido'
            });
            return;
        }

        try {
            const res = await fetch('/reportes/ventas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ filtro })
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || 'Error al obtener los datos');
            }

            const data = await res.json();

            if (!Array.isArray(data)) {
                throw new Error('Formato de respuesta inválido');
            }

            if (data.length === 0) {
                await Swal.fire({
                    icon: 'info',
                    title: 'Sin datos',
                    text: 'No hay ventas registradas para el período seleccionado.',
                    confirmButtonText: 'OK'
                });
                return;
            }

            await exportarExcelBonito(data, `reporte_ventas_${filtro}`);

            await Swal.fire({
                icon: 'success',
                title: '¡Reporte exportado!',
                text: 'El archivo Excel ha sido descargado exitosamente.',
                confirmButtonText: 'Aceptar',
                timer: 3000,
                timerProgressBar: true
            });

        } catch (err) {
            console.error('Error al generar reporte:', err);
            await Swal.fire({
                icon: 'error',
                title: 'Error',
                text: err.message || 'Ocurrió un error al generar el reporte.',
                confirmButtonText: 'Cerrar'
            });
        }
    });


    // Función para exportar los datos a Excel
    async function exportarExcelBonito(data, nombreArchivo) {
        const dataLimpia = data.map(item => ({
            Cod_Venta: item.Cod_Venta,
            Cod_Producto: item.Cod_Producto,
            Nombre_Producto: item.Nombre_Producto,
            Monto_Total: Number(parseFloat(item.Monto_Total).toFixed(2)),
            Fecha_Venta: new Date(item.Fecha_Venta).toLocaleDateString('es-ES')
        }));


        const ExcelJS = window.ExcelJS;
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Reporte');

        // Añadir encabezados
        const headers = Object.keys(dataLimpia[0]);
        worksheet.addRow(headers);

        const headerRow = worksheet.getRow(1);
        headerRow.eachCell(cell => {
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF4F81BD' }
            };
            cell.font = {
                bold: true,
                color: { argb: 'FFFFFFFF' }
            };
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
            cell.alignment = { vertical: 'middle', horizontal: 'center' };
        });

        // Agregar los datos
        dataLimpia.forEach(item => {
            const row = worksheet.addRow(Object.values(item));
            row.eachCell(cell => {
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
            });
        });

        const total = dataLimpia.reduce((sum, item) => sum + parseFloat(item.Monto_Total), 0);

        // Agregar fila de total de ventas
        const totalRow = worksheet.addRow(['', '', 'Total de Ventas', total, '']);

        totalRow.eachCell((cell, colNumber) => {
            cell.font = { bold: true };
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF4F81BD' }
            };
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
            if (colNumber === 4) {
                cell.numFmt = '#,##0.00'; // ✅ Formato US: 1,283.89
            }
        });

        // Ajustar anchos
        worksheet.columns.forEach(column => {
            column.width = 20;
        });

        // Descargar el archivo
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = nombreArchivo + '.xlsx';
        a.click();
        URL.revokeObjectURL(url);
    }


    // Aseguramos que solo se pueda seleccionar un checkbox
    document.getElementById('diario').addEventListener('change', () => {
        if (document.getElementById('diario').checked) {
            document.getElementById('semanal').checked = false;
            document.getElementById('mensual').checked = false;
        }
    });

    document.getElementById('semanal').addEventListener('change', () => {
        if (document.getElementById('semanal').checked) {
            document.getElementById('diario').checked = false;
            document.getElementById('mensual').checked = false;
        }
    });

    document.getElementById('mensual').addEventListener('change', () => {
        if (document.getElementById('mensual').checked) {
            document.getElementById('diario').checked = false;
            document.getElementById('semanal').checked = false;
        }
    });

    //Reporte Productos
   document.getElementById('exportarProductos').addEventListener('click', async () => {
    try {
        const res = await fetch('/reportes/productos');
        
        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.message || 'Error al obtener los datos');
        }

        const response = await res.json();
        
        // Validar que la respuesta tenga el formato esperado
        if (!response.success || !Array.isArray(response.data)) {
            throw new Error('Respuesta del servidor inválida');
        }

        const data = response.data;

        if (data.length === 0) {
            await Swal.fire({
                icon: 'info',
                title: 'Sin datos',
                text: 'No hay productos en el reporte.',
                confirmButtonText: 'OK'
            });
            return;
        }

        await exportarExcelProductos(data, 'reporte_productos');

        await Swal.fire({
            icon: 'success',
            title: '¡Reporte exportado!',
            text: 'El archivo Excel ha sido descargado exitosamente.',
            confirmButtonText: 'Aceptar',
            timer: 3000,
            timerProgressBar: true
        });

    } catch (err) {
        console.error('Error al exportar productos:', err);
        await Swal.fire({
            icon: 'error',
            title: 'Error',
            text: err.message || 'Ocurrió un error al generar el reporte.',
            confirmButtonText: 'Cerrar'
        });
    }
});

async function exportarExcelProductos(data, nombreArchivo) {
    try {
        const ExcelJS = window.ExcelJS;
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Productos');

        // Definir columnas
        worksheet.columns = [
            { header: 'Código', key: 'Cod_Producto', width: 15 },
            { header: 'Nombre', key: 'Nombre', width: 30 },
            { header: 'Cantidad Vendida', key: 'CantidadVendida', width: 20 },
            { header: 'Tipo', key: 'Tipo', width: 20 }
        ];

        // Estilo para el encabezado
        const headerRow = worksheet.getRow(1);
        headerRow.eachCell(cell => {
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF4F81BD' }
            };
            cell.font = {
                bold: true,
                color: { argb: 'FFFFFFFF' }
            };
            cell.alignment = { vertical: 'middle', horizontal: 'center' };
        });

        // Agregar datos
        data.forEach(item => {
            worksheet.addRow({
                Cod_Producto: item.Cod_Producto,
                Nombre: item.Nombre,
                CantidadVendida: item.CantidadVendida,
                Tipo: item.Tipo
            });
        });

        // Aplicar bordes a todas las celdas
        worksheet.eachRow(row => {
            row.eachCell(cell => {
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
            });
        });

        // Generar archivo
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], {
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${nombreArchivo}_${new Date().toISOString().slice(0,10)}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

    } catch (error) {
        console.error('Error al exportar Excel:', error);
        throw error;
    }
}
</script>